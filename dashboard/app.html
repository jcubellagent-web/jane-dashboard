<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#0a0a0a">
<link rel="manifest" href="/mobile/manifest.json">
<link rel="apple-touch-icon" href="/mobile/icon-192.svg">
<title>Jane Mobile</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
--bg:#0a0a0a;--card-bg:#111;--accent:#4ade80;--accent-dim:rgba(74,222,128,0.15);
--border:rgba(255,255,255,0.08);--text:#f1f5f9;--text-dim:#64748b;--text-muted:#475569;
--red:#ef4444;--amber:#f59e0b;
--safe-top:env(safe-area-inset-top);--safe-bottom:env(safe-area-inset-bottom);
--safe-left:env(safe-area-inset-left);--safe-right:env(safe-area-inset-right);
}
body{font-family:-apple-system,BlinkMacSystemFont,'SF Pro Display',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;-webkit-user-select:none;user-select:none;overflow-x:hidden;padding-bottom:calc(1rem + var(--safe-bottom))}
a{color:var(--accent);text-decoration:none}

/* Header */
.header{position:sticky;top:0;z-index:100;display:flex;align-items:center;justify-content:space-between;padding:calc(0.5rem + var(--safe-top)) 1rem 0.5rem;background:rgba(10,10,10,0.95);backdrop-filter:blur(20px);border-bottom:1px solid var(--border)}
.header-left{display:flex;flex-direction:column;gap:2px}
.greeting{font-size:1rem;font-weight:700;color:var(--accent)}
.header-date{font-size:0.65rem;color:var(--text-dim);font-family:'SF Mono',monospace;text-transform:uppercase;letter-spacing:0.5px}
.header-right{display:flex;align-items:center;gap:0.75rem}
.header-time{font-family:'SF Mono',monospace;font-size:1.1rem;font-weight:600;color:var(--accent);letter-spacing:1px}
.status-dot{width:8px;height:8px;background:var(--accent);border-radius:50%;animation:pulse 2s ease-in-out infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}

/* Notification Bell */
.notif-wrapper{position:relative;z-index:10000}
.notif-bell{background:none;border:none;font-size:1.3rem;padding:4px;cursor:pointer;color:#4ade80;filter:drop-shadow(0 0 4px rgba(74,222,128,0.4))}
.notif-bell .badge{position:absolute;top:-2px;right:-4px;background:var(--red);color:#fff;font-size:0.6rem;font-weight:700;min-width:15px;height:15px;border-radius:8px;display:flex;align-items:center;justify-content:center;padding:0 3px}
.notif-bell .badge.hidden{display:none}
.notif-dropdown{display:none;position:absolute;top:100%;right:-8px;margin-top:8px;width:calc(100vw - 2rem);max-width:360px;max-height:70vh;overflow-y:auto;background:rgba(15,15,15,0.98);border:1px solid var(--border);border-radius:12px;backdrop-filter:blur(20px);z-index:10000;box-shadow:0 8px 32px rgba(0,0,0,0.6)}
.notif-dropdown.open{display:block}
.notif-dropdown-header{padding:10px 14px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;font-size:0.8rem;font-weight:600;color:var(--accent)}
.notif-dropdown-header button{background:none;border:none;color:var(--text-dim);font-size:0.7rem;padding:4px 8px;border-radius:4px}
.notif-item{padding:10px 14px;border-bottom:1px solid rgba(255,255,255,0.04);display:flex;gap:8px;align-items:flex-start}
.notif-item.unread{border-left:2px solid var(--accent)}
.notif-icon{font-size:1rem;flex-shrink:0}
.notif-content{flex:1;min-width:0}
.notif-title{font-size:0.75rem;color:var(--text);line-height:1.3;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
.notif-time{font-size:0.6rem;color:var(--text-muted);margin-top:2px}
.notif-dismiss{background:none;border:none;color:var(--text-muted);font-size:0.85rem;padding:2px;flex-shrink:0}
.notif-empty{padding:24px;text-align:center;color:var(--text-muted);font-size:0.75rem}

/* Refresh */
.refresh-fab{position:fixed;bottom:calc(1.5rem + var(--safe-bottom));right:1rem;width:44px;height:44px;border-radius:50%;background:var(--accent);color:#000;border:none;font-size:1.2rem;z-index:50;box-shadow:0 4px 16px rgba(74,222,128,0.3);display:flex;align-items:center;justify-content:center}
.refresh-fab.spinning{animation:spin .5s linear infinite}
@keyframes spin{from{transform:rotate(0)}to{transform:rotate(360deg)}}

/* System Stats Strip */
.stats-strip{display:flex;gap:0.5rem;padding:0.5rem 1rem;overflow-x:auto;-webkit-overflow-scrolling:touch}
.stat-chip{display:flex;align-items:center;gap:4px;background:var(--card-bg);border:1px solid var(--border);border-radius:8px;padding:6px 10px;font-size:0.7rem;white-space:nowrap;flex-shrink:0}
.stat-chip .label{color:var(--text-dim);font-weight:500}
.stat-chip .val{color:var(--text);font-weight:600;font-family:'SF Mono',monospace}

/* Cards */
.cards{display:flex;flex-direction:column;gap:0.75rem;padding:0.75rem 1rem}
.card{background:var(--card-bg);border:1px solid rgba(74,222,128,0.15);border-radius:12px;overflow:hidden}
.card-header{display:flex;justify-content:space-between;align-items:center;padding:0.65rem 0.75rem;cursor:pointer;-webkit-tap-highlight-color:transparent}
.card-title{display:flex;align-items:center;gap:6px;font-size:0.8rem;font-weight:600}
.card-icon{font-size:0.95rem}
.card-chevron{color:var(--text-dim);font-size:0.7rem;transition:transform .2s}
.card.collapsed .card-chevron{transform:rotate(-90deg)}
.card.collapsed .card-body{display:none}
.card-body{padding:0 0.75rem 0.75rem}
.card-refresh{background:none;border:none;color:var(--accent);font-size:0.9rem;padding:4px}
.card-refresh.spinning{animation:spin .5s linear infinite}

/* Mind State */
.mind-task{font-size:0.8rem;font-weight:600;color:var(--accent);margin-bottom:6px}
.mind-thought{font-size:0.7rem;color:var(--text-dim);margin-bottom:8px;font-style:italic}
.mind-steps{display:flex;flex-direction:column;gap:4px}
.mind-step{font-size:0.7rem;display:flex;align-items:center;gap:6px}
.step-icon{font-size:0.75rem}

/* Briefing */
.breaking{background:linear-gradient(90deg,rgba(239,68,68,0.15),transparent);border-left:3px solid var(--red);padding:8px 10px;margin-bottom:8px;border-radius:0 6px 6px 0}
.breaking-label{font-size:0.6rem;font-weight:700;color:var(--red);text-transform:uppercase;letter-spacing:1px}
.breaking-text{font-size:0.75rem;margin-top:2px}
.briefing-summary{font-size:0.75rem;color:var(--text-dim);margin-bottom:8px;line-height:1.4}
.briefing-section{border-top:1px solid var(--border);padding-top:6px;margin-top:6px}
.briefing-section-header{font-size:0.7rem;font-weight:600;cursor:pointer;display:flex;justify-content:space-between;align-items:center;padding:4px 0;-webkit-tap-highlight-color:transparent}
.briefing-section-body{padding:6px 0;font-size:0.7rem;color:var(--text-dim);line-height:1.4}
.briefing-section.collapsed .briefing-section-body{display:none}
.importance-dot{width:6px;height:6px;border-radius:50%;flex-shrink:0}
.importance-high{background:var(--red)}
.importance-medium{background:var(--amber)}
.importance-low{background:var(--accent)}

/* X Growth */
.x-stats-row{display:grid;grid-template-columns:repeat(4,1fr);gap:6px;margin-bottom:8px}
.x-stat{text-align:center}
.x-stat-val{font-size:0.85rem;font-weight:700;color:var(--accent)}
.x-stat-label{font-size:0.55rem;color:var(--text-dim);text-transform:uppercase}
.pipeline{margin-bottom:8px}
.pipeline-item{display:flex;align-items:center;gap:6px;margin-bottom:4px;font-size:0.7rem}
.pipeline-bar{flex:1;height:4px;background:rgba(255,255,255,0.08);border-radius:2px;overflow:hidden}
.pipeline-fill{height:100%;background:var(--accent);border-radius:2px;transition:width .3s}
.drafts-toggle{font-size:0.7rem;color:var(--accent);cursor:pointer;padding:6px 0;font-weight:600;-webkit-tap-highlight-color:transparent}
.drafts-list{display:none;flex-direction:column;gap:4px}
.drafts-list.open{display:flex}
.draft-item{display:flex;align-items:center;gap:6px;padding:6px 8px;background:rgba(255,255,255,0.03);border-radius:6px;font-size:0.7rem}
.draft-item .draft-text{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.draft-btn{background:none;border:none;font-size:1rem;padding:2px 4px;cursor:pointer}
.draft-btn.approve{color:var(--accent)}
.draft-btn.reject{color:var(--red)}
.harvey{display:inline-block;width:12px;height:12px;border-radius:50%;border:1.5px solid var(--accent);position:relative;overflow:hidden;vertical-align:middle;margin-right:4px}
.harvey-fill{position:absolute;bottom:0;left:0;width:100%;background:var(--accent)}
.action-item{font-size:0.7rem;margin-bottom:3px;display:flex;align-items:center;gap:4px}
.queue-item{display:flex;align-items:flex-start;gap:6px;padding:6px 8px;background:rgba(255,255,255,0.03);border-radius:6px;font-size:0.7rem;margin-bottom:4px}
.queue-item .queue-text{flex:1;line-height:1.3}
.queue-type{font-size:0.55rem;color:var(--text-muted);text-transform:uppercase;font-weight:600}
.queue-status{font-size:0.55rem;padding:1px 5px;border-radius:3px;font-weight:600}
.queue-status.pending{background:rgba(245,158,11,0.2);color:var(--amber)}
.queue-status.approved{background:rgba(74,222,128,0.2);color:var(--accent)}
.queue-status.posted{background:rgba(74,222,128,0.1);color:var(--text-dim)}

/* TikTok */
.tiktok-stats{display:grid;grid-template-columns:repeat(3,1fr);gap:6px;margin-bottom:8px}
.tiktok-stat{text-align:center}
.tiktok-stat-val{font-size:0.85rem;font-weight:700;color:#ff6b9d}
.tiktok-stat-label{font-size:0.55rem;color:var(--text-dim);text-transform:uppercase}
.tiktok-stat-delta{font-size:0.55rem;margin-top:1px}
.tiktok-stat-delta.positive{color:var(--accent)}
.tiktok-stat-delta.negative{color:var(--red)}
.tiktok-stat-delta.neutral{color:var(--text-muted)}
.tiktok-video{display:flex;gap:8px;padding:6px 8px;background:rgba(255,255,255,0.03);border-radius:6px;font-size:0.7rem}
.tiktok-video-info{flex:1}
.tiktok-video-desc{color:var(--text);margin-bottom:2px;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
.tiktok-video-meta{color:var(--text-dim);font-size:0.6rem}

/* Crypto Ticker */
.ticker-row{display:flex;gap:8px;flex-wrap:wrap}
.ticker-item{flex:1;min-width:80px;display:flex;align-items:center;gap:6px;padding:8px;background:rgba(255,255,255,0.03);border-radius:8px}
.ticker-symbol{font-size:0.7rem;font-weight:700}
.ticker-price{font-size:0.75rem;font-weight:600}
.ticker-change{font-size:0.6rem;font-weight:500}
.ticker-change.positive{color:var(--accent)}
.ticker-change.negative{color:var(--red)}

/* Sorare */
.sorare-info{font-size:0.7rem;color:var(--text-dim);margin-bottom:6px}
.sorare-cards{font-size:0.8rem;font-weight:600;margin-bottom:4px}
.sorare-gameweek{font-size:0.7rem;color:var(--text-dim)}
.sorare-games{display:flex;flex-direction:column;gap:4px;margin-top:6px}
.sorare-game{font-size:0.7rem;padding:4px 8px;background:rgba(255,255,255,0.03);border-radius:4px}

/* Memecoins */
.memecoin-list{display:flex;flex-direction:column;gap:6px}
.memecoin-item{display:flex;align-items:center;gap:8px;padding:8px;background:rgba(255,255,255,0.03);border-radius:8px}
.memecoin-icon{width:24px;height:24px;border-radius:50%}
.memecoin-info{flex:1}
.memecoin-name{font-size:0.75rem;font-weight:600}
.memecoin-mcap{font-size:0.6rem;color:var(--text-dim)}
.memecoin-price{text-align:right}
.memecoin-price-val{font-size:0.75rem;font-weight:600}
.memecoin-price-change{font-size:0.6rem}

/* Predictions */
.prediction-list{display:flex;flex-direction:column;gap:6px}
.prediction-item{padding:8px;background:rgba(255,255,255,0.03);border-radius:8px;cursor:pointer}
.prediction-q{font-size:0.7rem;margin-bottom:4px;line-height:1.3}
.prediction-odds{display:flex;gap:6px;align-items:center}
.odds-yes{font-size:0.7rem;font-weight:700;color:var(--accent)}
.odds-no{font-size:0.7rem;color:var(--text-dim)}
.prediction-source{font-size:0.55rem;color:var(--text-muted);margin-left:auto}
.prediction-category{font-size:0.6rem;font-weight:600;color:var(--accent);text-transform:uppercase;letter-spacing:0.5px;padding:6px 0 2px;border-bottom:1px solid var(--border);margin-bottom:4px}

/* AI News */
.news-list{display:flex;flex-direction:column;gap:6px}
.news-item{padding:8px;background:rgba(255,255,255,0.03);border-radius:8px;cursor:pointer}
.news-headline{font-size:0.7rem;font-weight:600;line-height:1.3;margin-bottom:2px}
.news-meta{font-size:0.6rem;color:var(--text-dim)}

/* Connections */
.connections-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:6px}
.conn-item{display:flex;align-items:center;gap:6px;padding:8px;background:rgba(255,255,255,0.03);border-radius:8px;font-size:0.7rem}
.conn-dot{width:6px;height:6px;border-radius:50%;flex-shrink:0}
.conn-dot.online{background:var(--accent);box-shadow:0 0 4px var(--accent)}
.conn-dot.offline{background:var(--red)}

/* Tasks & Cron */
.task-list{display:flex;flex-direction:column;gap:4px}
.task-item{display:flex;align-items:flex-start;gap:6px;font-size:0.7rem;padding:4px 0}
.task-status{font-size:0.75rem;flex-shrink:0}
.cron-item{font-size:0.7rem;padding:4px 0;display:flex;justify-content:space-between}
.cron-schedule{font-family:'SF Mono',monospace;font-size:0.6rem;color:var(--text-dim)}
</style>
</head>
<body>

<!-- Header -->
<div class="header">
  <div class="header-left">
    <div class="greeting" id="greeting">Good evening, Josh</div>
    <div class="header-date" id="header-date"></div>
  </div>
  <div class="header-right">
    <span class="status-dot"></span>
    <span class="header-time" id="header-time"></span>
    <div class="notif-wrapper">
      <button class="notif-bell" id="notif-bell" onclick="toggleNotif()">üîî<span class="badge hidden" id="notif-badge">0</span></button>
      <div class="notif-dropdown" id="notif-dropdown">
        <div class="notif-dropdown-header">
          <span>Notifications</span>
          <button onclick="markAllRead()">Mark all read</button>
        </div>
        <div id="notif-list"><div class="notif-empty">No notifications</div></div>
      </div>
    </div>
  </div>
</div>

<!-- System Stats Strip -->
<div class="stats-strip" id="stats-strip">
  <div class="stat-chip"><span class="label">CPU‚ÇÅ</span><span class="val" id="cpu1">‚Äî</span></div>
  <div class="stat-chip"><span class="label">RAM‚ÇÅ</span><span class="val" id="ram1">‚Äî</span></div>
  <div class="stat-chip"><span class="label">CPU‚ÇÇ</span><span class="val" id="cpu2">‚Äî</span></div>
  <div class="stat-chip"><span class="label">RAM‚ÇÇ</span><span class="val" id="ram2">‚Äî</span></div>
  <div class="stat-chip"><span class="label">CTX</span><span class="val" id="ctx-usage">‚Äî</span></div>
</div>

<!-- Cards -->
<div class="cards">

<!-- Mind State -->
<div class="card" id="card-mind">
  <div class="card-header" onclick="toggleCard('card-mind')">
    <span class="card-title"><span class="card-icon">üß†</span>Mind State</span>
    <span class="card-chevron">‚ñº</span>
  </div>
  <div class="card-body">
    <div class="mind-task" id="mind-task">Idle</div>
    <div class="mind-thought" id="mind-thought"></div>
    <div class="mind-steps" id="mind-steps"></div>
  </div>
</div>

<!-- Daily Briefing -->
<div class="card" id="card-briefing">
  <div class="card-header" onclick="toggleCard('card-briefing')">
    <span class="card-title"><span class="card-icon">üìã</span>Daily Briefing</span>
    <span class="card-chevron">‚ñº</span>
  </div>
  <div class="card-body" id="briefing-body">
    <div class="briefing-summary">Loading...</div>
  </div>
</div>

<!-- X Growth -->
<div class="card" id="card-x">
  <div class="card-header" onclick="toggleCard('card-x')">
    <span class="card-title"><span class="card-icon">ùïè</span>X Growth</span>
    <span class="card-chevron">‚ñº</span>
  </div>
  <div class="card-body">
    <div class="x-stats-row" id="x-stats">
      <div class="x-stat"><div class="x-stat-val" id="x-followers">‚Äî</div><div class="x-stat-label">Followers</div></div>
      <div class="x-stat"><div class="x-stat-val" id="x-following">‚Äî</div><div class="x-stat-label">Following</div></div>
      <div class="x-stat"><div class="x-stat-val" id="x-tweets">‚Äî</div><div class="x-stat-label">Tweets</div></div>
      <div class="x-stat"><div class="x-stat-val" id="x-impressions">‚Äî</div><div class="x-stat-label">Impressions</div></div>
    </div>
    <div class="pipeline" id="x-pipeline"></div>
    <div class="drafts-toggle" id="drafts-toggle" onclick="toggleDrafts()" style="display:none">0 drafts pending ‚ñ∏</div>
    <div class="drafts-list" id="drafts-list"></div>
    <div id="x-plan"></div>
    <div id="x-queue" style="margin-top:8px"></div>
  </div>
</div>

<!-- TikTok -->
<div class="card" id="card-tiktok">
  <div class="card-header" onclick="toggleCard('card-tiktok')">
    <span class="card-title"><span class="card-icon">üéµ</span>TikTok</span>
    <span class="card-chevron">‚ñº</span>
  </div>
  <div class="card-body">
    <div class="tiktok-stats" id="tiktok-stats">
      <div class="tiktok-stat"><div class="tiktok-stat-val" id="tt-followers">‚Äî</div><div class="tiktok-stat-label">Followers</div><div class="tiktok-stat-delta neutral" id="tt-followers-d">‚Äî</div></div>
      <div class="tiktok-stat"><div class="tiktok-stat-val" id="tt-likes">‚Äî</div><div class="tiktok-stat-label">Likes</div><div class="tiktok-stat-delta neutral" id="tt-likes-d">‚Äî</div></div>
      <div class="tiktok-stat"><div class="tiktok-stat-val" id="tt-views">‚Äî</div><div class="tiktok-stat-label">Views</div><div class="tiktok-stat-delta neutral" id="tt-views-d">‚Äî</div></div>
    </div>
    <div id="tiktok-videos"></div>
  </div>
</div>

<!-- Crypto Ticker -->
<div class="card" id="card-ticker">
  <div class="card-header" onclick="toggleCard('card-ticker')">
    <span class="card-title"><span class="card-icon">üìà</span>Crypto</span>
    <span class="card-chevron">‚ñº</span>
  </div>
  <div class="card-body">
    <div class="ticker-row" id="ticker-row"></div>
  </div>
</div>

<!-- Sorare -->
<div class="card collapsed" id="card-sorare">
  <div class="card-header" onclick="toggleCard('card-sorare')">
    <span class="card-title"><span class="card-icon">üèÄ</span>Sorare</span>
    <span class="card-chevron">‚ñº</span>
  </div>
  <div class="card-body" id="sorare-body">
    <div class="sorare-info">Loading...</div>
  </div>
</div>

<!-- Memecoins -->
<div class="card collapsed" id="card-memecoins">
  <div class="card-header" onclick="toggleCard('card-memecoins')">
    <span class="card-title"><span class="card-icon">üê∏</span>Memecoins</span>
    <span class="card-chevron">‚ñº</span>
  </div>
  <div class="card-body">
    <div class="memecoin-list" id="memecoin-list"></div>
  </div>
</div>

<!-- Prediction Markets -->
<div class="card collapsed" id="card-predictions">
  <div class="card-header" onclick="toggleCard('card-predictions')">
    <span class="card-title"><span class="card-icon">üîÆ</span>Predictions</span>
    <span class="card-chevron">‚ñº</span>
  </div>
  <div class="card-body">
    <div class="prediction-list" id="prediction-list"></div>
  </div>
</div>

<!-- AI News -->
<div class="card collapsed" id="card-news">
  <div class="card-header" onclick="toggleCard('card-news')">
    <span class="card-title"><span class="card-icon">ü§ñ</span>AI News</span>
    <span class="card-chevron">‚ñº</span>
  </div>
  <div class="card-body">
    <div class="news-list" id="news-list"></div>
  </div>
</div>

<!-- Connections -->
<div class="card collapsed" id="card-connections">
  <div class="card-header" onclick="toggleCard('card-connections')">
    <span class="card-title"><span class="card-icon">üîó</span>Connections</span>
    <span class="card-chevron">‚ñº</span>
  </div>
  <div class="card-body">
    <div class="connections-grid" id="connections-grid"></div>
  </div>
</div>

<!-- Tasks -->
<div class="card collapsed" id="card-tasks">
  <div class="card-header" onclick="toggleCard('card-tasks')">
    <span class="card-title"><span class="card-icon">‚úÖ</span>Tasks</span>
    <span class="card-chevron">‚ñº</span>
  </div>
  <div class="card-body">
    <div class="task-list" id="task-list"></div>
  </div>
</div>

<!-- Cron Jobs -->
<div class="card collapsed" id="card-cron">
  <div class="card-header" onclick="toggleCard('card-cron')">
    <span class="card-title"><span class="card-icon">‚è∞</span>Cron Jobs</span>
    <span class="card-chevron">‚ñº</span>
  </div>
  <div class="card-body">
    <div class="task-list" id="cron-list"></div>
  </div>
</div>

</div><!-- /cards -->

<!-- Refresh FAB -->
<button class="refresh-fab" id="refresh-fab" onclick="refreshAll()">‚Üª</button>

<script>
const API=location.origin;
const fmt=n=>{if(!n&&n!==0)return'‚Äî';return Number(n).toLocaleString()};
const fmtK=n=>{if(!n)return'0';if(n>=1e6)return(n/1e6).toFixed(1)+'M';if(n>=1e3)return(n/1e3).toFixed(1)+'K';return n.toLocaleString()};

async function fetchWithTimeout(url,ms=8000){const c=new AbortController();const t=setTimeout(()=>c.abort(),ms);try{const r=await fetch(API+url,{signal:c.signal});clearTimeout(t);return r.json()}catch(e){clearTimeout(t);console.error('Fetch error:',url,e);return null}}

// Clock & greeting
function updateClock(){
  const now=new Date();
  const h=now.getHours();
  const greeting=h<12?'Good morning':h<17?'Good afternoon':'Good evening';
  document.getElementById('greeting').textContent=greeting+', Josh';
  document.getElementById('header-time').textContent=now.toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit'});
  document.getElementById('header-date').textContent=now.toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric'});
}
updateClock();setInterval(updateClock,10000);

// Card toggle
function toggleCard(id){document.getElementById(id).classList.toggle('collapsed')}

// Notifications
let notifData=[];
function toggleNotif(){document.getElementById('notif-dropdown').classList.toggle('open')}
document.addEventListener('click',e=>{if(!e.target.closest('.notif-wrapper'))document.getElementById('notif-dropdown').classList.remove('open')});

async function refreshNotifications(){
  const d=await fetchWithTimeout('/api/notifications');
  if(!d)return;
  notifData=d.notifications||d||[];
  const badge=document.getElementById('notif-badge');
  const unread=notifData.filter(n=>!n.read).length;
  badge.textContent=unread;badge.classList.toggle('hidden',!unread);
  const list=document.getElementById('notif-list');
  if(!notifData.length){list.innerHTML='<div class="notif-empty">No notifications</div>';return}
  list.innerHTML=notifData.slice(0,20).map(n=>`
    <div class="notif-item ${n.read?'':'unread'}">
      <span class="notif-icon">${n.icon||'üìå'}</span>
      <div class="notif-content">
        <div class="notif-title">${n.title||n.message||''}</div>
        <div class="notif-time">${n.time||n.timestamp||''}</div>
      </div>
      <button class="notif-dismiss" onclick="dismissNotif('${n.id}')">√ó</button>
    </div>
  `).join('');
}
async function dismissNotif(id){await fetch(API+'/api/notifications/dismiss',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id})});refreshNotifications()}
async function markAllRead(){await fetch(API+'/api/notifications/read',{method:'POST'});refreshNotifications()}

// System
async function refreshSystem(){
  const d=await fetchWithTimeout('/api/system');
  if(!d)return;
  document.getElementById('cpu1').textContent=(d.cpu||0)+'%';
  document.getElementById('ram1').textContent=(d.memory||0)+'%';
  if(d.mini2&&d.mini2.online){
    document.getElementById('cpu2').textContent=(d.mini2.cpu||0)+'%';
    document.getElementById('ram2').textContent=(d.mini2.memory||0)+'%';
  }else{
    document.getElementById('cpu2').textContent='OFF';document.getElementById('cpu2').style.color='var(--red)';
    document.getElementById('ram2').textContent='OFF';document.getElementById('ram2').style.color='var(--red)';
  }
  // Usage
  const u=await fetchWithTimeout('/api/usage');
  if(u&&u.contextPercent!=null){
    const el=document.getElementById('ctx-usage');
    el.textContent=u.contextPercent+'%';
    el.style.color=u.contextPercent>80?'var(--red)':u.contextPercent>50?'var(--amber)':'';
  }
}

// Mind
async function refreshMind(){
  const d=await fetchWithTimeout('/api/mind');
  if(!d)return;
  document.getElementById('mind-task').textContent=d.task||d.currentTask||'Idle';
  document.getElementById('mind-thought').textContent=d.thought||d.currentThought||'';
  const steps=d.steps||d.recentSteps||[];
  document.getElementById('mind-steps').innerHTML=steps.slice(0,5).map(s=>{
    const icon=s.status==='done'||s.complete?'‚úÖ':s.status==='active'?'‚ö°':'‚è≥';
    return`<div class="mind-step"><span class="step-icon">${icon}</span>${s.text||s.name||s}</div>`;
  }).join('');
}

// Briefing
async function refreshBriefing(){
  const d=await fetchWithTimeout('/api/briefing',12000);
  if(!d)return;
  const body=document.getElementById('briefing-body');
  let html='';
  if(d.breaking){html+=`<div class="breaking"><div class="breaking-label">‚ö° BREAKING</div><div class="breaking-text">${d.breaking}</div></div>`}
  if(d.summary){html+=`<div class="briefing-summary">${d.summary}</div>`}
  const sections=d.sections||[];
  sections.forEach((s,i)=>{
    const imp=s.importance||'low';
    const dotClass=imp==='high'?'importance-high':imp==='medium'?'importance-medium':'importance-low';
    html+=`<div class="briefing-section${i>1?' collapsed':''}" id="bsec-${i}">
      <div class="briefing-section-header" onclick="document.getElementById('bsec-${i}').classList.toggle('collapsed')">
        <span style="display:flex;align-items:center;gap:6px"><span class="importance-dot ${dotClass}"></span>${s.title||s.topic||'Section'}</span>
        <span style="font-size:0.6rem;color:var(--text-dim)">‚ñº</span>
      </div>
      <div class="briefing-section-body">${Array.isArray(s.items)?s.items.map(it=>'‚Ä¢ '+(it.text||it.title||it)).join('<br>'):(s.content||s.body||'')}</div>
    </div>`;
  });
  body.innerHTML=html||'<div class="briefing-summary">No briefing available</div>';
}

// X Growth
async function refreshX(){
  const [stats,queue,plan]=await Promise.all([
    fetchWithTimeout('/api/x-stats'),
    fetchWithTimeout('/api/x-queue'),
    fetchWithTimeout('/api/x-plan')
  ]);
  if(stats){
    document.getElementById('x-followers').textContent=fmt(stats.followers);
    document.getElementById('x-following').textContent=fmt(stats.following);
    document.getElementById('x-tweets').textContent=fmt(stats.tweets||stats.tweetCount);
    document.getElementById('x-impressions').textContent=fmtK(stats.impressions);
  }
  // Pipeline
  if(stats){
    const pp=document.getElementById('x-pipeline');
    const tw=stats.tweetsPipeline||{done:0,target:3};
    const rp=stats.repliesPipeline||{done:0,target:5};
    pp.innerHTML=`
      <div class="pipeline-item"><span style="min-width:50px">Tweets</span><div class="pipeline-bar"><div class="pipeline-fill" style="width:${Math.min(100,(tw.done/tw.target)*100)}%"></div></div><span style="font-size:0.6rem;color:var(--text-dim)">${tw.done}/${tw.target}</span></div>
      <div class="pipeline-item"><span style="min-width:50px">Replies</span><div class="pipeline-bar"><div class="pipeline-fill" style="width:${Math.min(100,(rp.done/rp.target)*100)}%"></div></div><span style="font-size:0.6rem;color:var(--text-dim)">${rp.done}/${rp.target}</span></div>
    `;
  }
  // Plan (drafts)
  if(plan){
    const ideas=plan.contentIdeas||plan.ideas||[];
    const pending=ideas.filter(i=>i.status==='pending'||!i.status);
    const toggle=document.getElementById('drafts-toggle');
    if(pending.length){
      toggle.style.display='block';
      toggle.textContent=pending.length+' drafts pending ‚ñ∏';
      document.getElementById('drafts-list').innerHTML=pending.map(d=>`
        <div class="draft-item">
          <span class="draft-text">${d.text||d.content||d.idea||''}</span>
          <button class="draft-btn approve" onclick="event.stopPropagation();approveDraft('${d.id}')">‚úÖ</button>
          <button class="draft-btn reject" onclick="event.stopPropagation();rejectDraft('${d.id}')">‚ùå</button>
        </div>
      `).join('');
    }else{toggle.style.display='none'}
    // Action plan with Harvey balls
    const actions=plan.actionPlan||plan.actions||[];
    if(actions.length){
      document.getElementById('x-plan').innerHTML='<div style="font-size:0.65rem;font-weight:600;color:var(--text-dim);text-transform:uppercase;margin:6px 0 4px">Action Plan</div>'+
        actions.map(a=>{
          const pct=a.progress||0;
          return`<div class="action-item"><span class="harvey"><span class="harvey-fill" style="height:${pct}%"></span></span>${a.text||a.action||a}</div>`;
        }).join('');
    }
  }
  // Queue
  if(queue){
    const items=queue.pending||queue.queue||[];
    const recent=queue.recent||[];
    const all=[...items,...recent].slice(0,5);
    if(all.length){
      document.getElementById('x-queue').innerHTML='<div style="font-size:0.65rem;font-weight:600;color:var(--text-dim);text-transform:uppercase;margin-bottom:4px">Queue</div>'+
        all.map(q=>{
          const st=q.status||'pending';
          const stClass=st==='posted'?'posted':st==='approved'?'approved':'pending';
          const btns=st==='pending'?`<button class="draft-btn approve" onclick="event.stopPropagation();approveQueue('${q.id}')">‚úÖ</button><button class="draft-btn reject" onclick="event.stopPropagation();rejectQueue('${q.id}')">‚ùå</button>`:'';
          return`<div class="queue-item"><div class="queue-text"><span class="queue-type">${q.type||'tweet'}</span> ${q.content||q.text||''}</div><span class="queue-status ${stClass}">${st}</span>${btns}</div>`;
        }).join('');
    }
  }
}
function toggleDrafts(){document.getElementById('drafts-list').classList.toggle('open')}
async function approveDraft(id){await fetch(API+'/api/x-plan/approve/'+id,{method:'POST'});refreshX()}
async function rejectDraft(id){await fetch(API+'/api/x-plan/reject/'+id,{method:'POST'});refreshX()}
async function approveQueue(id){await fetch(API+'/api/x-queue/approve/'+id,{method:'POST'});refreshX()}
async function rejectQueue(id){await fetch(API+'/api/x-queue/reject/'+id,{method:'POST'});refreshX()}

// TikTok
async function refreshTikTok(){
  const d=await fetchWithTimeout('/api/tiktok');
  if(!d)return;
  const p=d.profile||d;
  const ch=d.changes24h||{};
  document.getElementById('tt-followers').textContent=fmt(p.followers);
  document.getElementById('tt-likes').textContent=fmt(p.likes||p.totalLikes);
  document.getElementById('tt-views').textContent=fmtK(d.totalViews||0);
  const fmtDelta=(v)=>{if(!v||v===0)return{t:'‚Äî',c:'neutral'};return{t:(v>0?'+':'')+v.toLocaleString(),c:v>0?'positive':'negative'}};
  const fd=fmtDelta(ch.followers);document.getElementById('tt-followers-d').textContent=fd.t;document.getElementById('tt-followers-d').className='tiktok-stat-delta '+fd.c;
  const ld=fmtDelta(ch.likes);document.getElementById('tt-likes-d').textContent=ld.t;document.getElementById('tt-likes-d').className='tiktok-stat-delta '+ld.c;
  const vd=fmtDelta(ch.views);document.getElementById('tt-views-d').textContent=vd.t;document.getElementById('tt-views-d').className='tiktok-stat-delta '+vd.c;
  const vids=d.recentVideos||d.videos||[];
  document.getElementById('tiktok-videos').innerHTML=vids.slice(0,3).map(v=>`
    <div class="tiktok-video">
      <div class="tiktok-video-info">
        <div class="tiktok-video-desc">${v.description||v.desc||'Video'}</div>
        <div class="tiktok-video-meta">üëÅ ${fmtK(v.views||0)} ‚Ä¢ ‚ù§Ô∏è ${fmtK(v.likes||0)} ‚Ä¢ üí¨ ${fmtK(v.comments||0)}</div>
      </div>
    </div>
  `).join('');
}

// Crypto
async function refreshTicker(){
  const d=await fetchWithTimeout('/api/ticker');
  if(!d)return;
  const coins=d.prices||d.coins||d;
  const arr=Array.isArray(coins)?coins:Object.entries(coins).map(([k,v])=>({symbol:k,...(typeof v==='object'?v:{price:v})}));
  document.getElementById('ticker-row').innerHTML=arr.slice(0,6).map(c=>{
    const ch=c.change24h||c.change||0;
    const chClass=ch>0?'positive':ch<0?'negative':'';
    return`<div class="ticker-item"><div><div class="ticker-symbol">${(c.symbol||'').toUpperCase()}</div><div class="ticker-price">$${typeof c.price==='number'?c.price.toLocaleString(undefined,{maximumFractionDigits:2}):c.price}</div><div class="ticker-change ${chClass}">${ch>0?'+':''}${typeof ch==='number'?ch.toFixed(2)+'%':ch}</div></div></div>`;
  }).join('');
}

// Sorare
async function refreshSorare(){
  const d=await fetchWithTimeout('/api/sorare');
  if(!d)return;
  let html='';
  if(d.cards||d.cardCount){html+=`<div class="sorare-cards">üÉè ${d.cardCount||d.cards?.length||0} NBA Cards</div>`}
  if(d.clubName){html+=`<div class="sorare-info">Club: ${d.clubName}</div>`}
  if(d.gameweek){html+=`<div class="sorare-gameweek">GW: ${d.gameweek.name||d.gameweek}</div>`}
  const games=d.liveGames||d.games||[];
  if(games.length){
    html+='<div class="sorare-games">'+games.slice(0,5).map(g=>`<div class="sorare-game">${g.home||''} vs ${g.away||''} ${g.score||''}</div>`).join('')+'</div>';
  }
  document.getElementById('sorare-body').innerHTML=html||'<div class="sorare-info">No data</div>';
}

// Memecoins
async function refreshMemecoins(){
  const d=await fetchWithTimeout('/api/memecoins')||await fetchWithTimeout('/api/dgen');
  if(!d)return;
  const coins=d.tokens||d.coins||d.memecoins||[];
  document.getElementById('memecoin-list').innerHTML=coins.slice(0,8).map(c=>{
    const ch=c.priceChange24h||c.change24h||0;
    const chClass=ch>0?'positive':ch<0?'negative':'';
    return`<div class="memecoin-item">
      ${c.icon||c.image?`<img class="memecoin-icon" src="${c.icon||c.image}" alt="">`:'<div class="memecoin-icon" style="background:var(--accent-dim);display:flex;align-items:center;justify-content:center;font-size:0.6rem">${(c.symbol||'?')[0]}</div>'}
      <div class="memecoin-info"><div class="memecoin-name">${c.name||c.symbol||'?'} <span style="color:var(--text-dim);font-size:0.6rem">${c.symbol||''}</span></div><div class="memecoin-mcap">MCap: ${fmtK(c.marketCap||c.mcap||0)}</div></div>
      <div class="memecoin-price"><div class="memecoin-price-val">$${c.price?Number(c.price).toPrecision(4):'-'}</div><div class="memecoin-price-change ticker-change ${chClass}">${ch>0?'+':''}${typeof ch==='number'?ch.toFixed(1)+'%':ch}</div></div>
    </div>`;
  }).join('')||'<div style="font-size:0.7rem;color:var(--text-dim)">No data</div>';
}

// Predictions
async function refreshPredictions(){
  const d=await fetchWithTimeout('/api/predictions',12000);
  if(!d||!d.markets)return;
  const markets=d.markets.slice(0,15);
  document.getElementById('prediction-list').innerHTML=markets.map(m=>{
    const src=m.source||'Polymarket';
    return`<div class="prediction-item" onclick="window.open('${m.url||'#'}','_blank')">
      <div class="prediction-q">${m.question}</div>
      <div class="prediction-odds"><span class="odds-yes">${m.yesOdds}% Yes</span><span class="odds-no">${m.noOdds}% No</span><span class="prediction-source">${src}</span></div>
    </div>`;
  }).join('')||'<div style="font-size:0.7rem;color:var(--text-dim)">No markets</div>';
}

// AI News
async function refreshNews(){
  const d=await fetchWithTimeout('/api/ai-news',10000);
  if(!d)return;
  const all=[];
  if(d.featured)all.push({...d.featured,featured:true});
  (d.agenticEnterprise||[]).forEach(i=>all.push(i));
  (d.agenticRetail||[]).forEach(i=>all.push(i));
  document.getElementById('news-list').innerHTML=all.slice(0,8).map(n=>`
    <div class="news-item" onclick="window.open('${n.link||'#'}','_blank')">
      <div class="news-headline">${n.featured?'‚≠ê ':''}${n.title}</div>
      <div class="news-meta">${n.source||''} ‚Ä¢ ${n.date||''}</div>
    </div>
  `).join('')||'<div style="font-size:0.7rem;color:var(--text-dim)">No news</div>';
}

// Connections
async function refreshConnections(){
  const d=await fetchWithTimeout('/api/connections');
  if(!d)return;
  const conns=d.connections||d;
  const arr=Array.isArray(conns)?conns:Object.entries(conns).map(([k,v])=>({name:k,...(typeof v==='object'?v:{status:v})}));
  document.getElementById('connections-grid').innerHTML=arr.map(c=>{
    const on=c.status==='connected'||c.status==='online'||c.connected||c.online;
    return`<div class="conn-item"><span class="conn-dot ${on?'online':'offline'}"></span>${c.name||c.service||''}</div>`;
  }).join('');
}

// Tasks
async function refreshTasks(){
  const d=await fetchWithTimeout('/api/tasks');
  if(!d)return;
  const tasks=d.tasks||d||[];
  document.getElementById('task-list').innerHTML=tasks.slice(0,10).map(t=>{
    const done=t.done||t.completed||t.status==='done';
    return`<div class="task-item"><span class="task-status">${done?'‚úÖ':'‚¨ú'}</span><span>${t.text||t.title||t.name||t}</span></div>`;
  }).join('')||'<div style="font-size:0.7rem;color:var(--text-dim)">No tasks</div>';
}

// Cron
async function refreshCron(){
  const d=await fetchWithTimeout('/api/cron');
  if(!d)return;
  const jobs=d.jobs||d||[];
  document.getElementById('cron-list').innerHTML=jobs.slice(0,10).map(j=>`
    <div class="cron-item"><span>${j.name||j.label||j.command||j}</span><span class="cron-schedule">${j.schedule||j.interval||''}</span></div>
  `).join('')||'<div style="font-size:0.7rem;color:var(--text-dim)">No cron jobs</div>';
}

// WebSocket
function connectWS(){
  try{
    const proto=location.protocol==='https:'?'wss':'ws';
    const ws=new WebSocket(`${proto}://${location.host}`);
    ws.onmessage=e=>{
      try{
        const d=JSON.parse(e.data);
        if(d.type==='mind'||d.mind)refreshMind();
        if(d.type==='system'||d.system)refreshSystem();
      }catch(err){}
    };
    ws.onclose=()=>setTimeout(connectWS,5000);
    ws.onerror=()=>ws.close();
  }catch(e){setTimeout(connectWS,10000)}
}

// Refresh all
async function refreshAll(){
  const fab=document.getElementById('refresh-fab');
  fab.classList.add('spinning');
  await Promise.allSettled([
    refreshSystem(),refreshMind(),refreshNotifications(),refreshBriefing(),
    refreshX(),refreshTikTok(),refreshTicker(),refreshSorare(),
    refreshMemecoins(),refreshPredictions(),refreshNews(),
    refreshConnections(),refreshTasks(),refreshCron()
  ]);
  fab.classList.remove('spinning');
}

// Init
refreshAll();
connectWS();
setInterval(()=>{
  refreshSystem();refreshMind();refreshNotifications();
},30000);
setInterval(()=>{
  refreshBriefing();refreshX();refreshTikTok();refreshTicker();
  refreshMemecoins();refreshPredictions();refreshNews();
  refreshConnections();refreshTasks();refreshCron();
},60000);

// Service Worker
if('serviceWorker' in navigator){navigator.serviceWorker.register('/mobile/sw.js').catch(()=>{})}
</script>
</body>
</html>
