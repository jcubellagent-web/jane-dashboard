<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <title>Jane Dashboard v3</title>
    <link rel="icon" href="icon-192.png">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --bg: #000000;
            --card: rgba(20, 20, 20, 0.8);
            --card-hover: rgba(30, 30, 30, 0.9);
            --accent: #4ade80;
            --accent-dim: rgba(74, 222, 128, 0.2);
            --text: #f1f5f9;
            --text-dim: #64748b;
            --green: #4ade80;
            --red: #ef4444;
            --border: rgba(74, 222, 128, 0.15);
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Inter', sans-serif;
            background: var(--bg);
            color: var(--text);
            height: 100vh;
            overflow: hidden;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.6rem 2rem;
            border-bottom: 1px solid rgba(74, 222, 128, 0.2);
            background:
                radial-gradient(ellipse 80% 50% at 20% 40%, rgba(74, 222, 128, 0.08) 0%, transparent 50%),
                linear-gradient(180deg, rgba(15, 20, 25, 0.98) 0%, rgba(10, 15, 20, 0.99) 100%);
            backdrop-filter: blur(20px);
            z-index: 100;
            height: 56px;
            position: relative;
            overflow: hidden;
        }
        .header::after {
            content: '';
            position: absolute;
            top: 0; left: 0;
            width: 40%; height: 100%;
            background: linear-gradient(90deg, transparent 0%, rgba(74,222,128,0.08) 20%, rgba(74,222,128,0.2) 50%, rgba(74,222,128,0.08) 80%, transparent 100%);
            filter: blur(12px);
            animation: headerSweep 6s ease-in-out infinite alternate;
            pointer-events: none;
        }
        @keyframes headerSweep { 0% { transform: translateX(-20%); } 100% { transform: translateX(180%); } }
        .header > * { position: relative; z-index: 2; }
        .header-left {
            display: flex; align-items: center; gap: 1rem; padding-left: 1rem;
        }
        @keyframes clawWave {
            0%, 85% { transform: rotate(0deg); }
            88% { transform: rotate(-15deg); }
            91% { transform: rotate(12deg); }
            94% { transform: rotate(-10deg); }
            97% { transform: rotate(5deg); }
            100% { transform: rotate(0deg); }
        }
        .oc-logo-animated { animation: clawWave 8s ease-in-out infinite; transform-origin: center bottom; }
        .header-time {
            font-family: 'SF Mono', 'Fira Code', monospace;
            font-size: 1.2rem; font-weight: 600; color: var(--accent);
            font-variant-numeric: tabular-nums; letter-spacing: 1px;
        }
        .header-date {
            font-family: 'SF Mono', 'Fira Code', monospace;
            font-size: 0.7rem; color: var(--accent); opacity: 0.8;
            letter-spacing: 1px; text-transform: uppercase;
        }
        .night-mode-btn {
            width: 40px; height: 40px; padding: 0;
            font-size: 0.45rem; color: var(--accent);
            background: linear-gradient(135deg, rgba(74,222,128,0.1), rgba(74,222,128,0.05));
            border: 1px solid rgba(74,222,128,0.3); border-radius: 8px;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            line-height: 1.2; text-transform: uppercase; letter-spacing: 0.5px;
        }
        .night-mode-btn:hover { background: rgba(74,222,128,0.2); border-color: rgba(74,222,128,0.5); }
        .refresh-all-btn {
            background: none; border: 1px solid var(--accent); color: var(--accent);
            cursor: pointer; padding: 0.4rem 0.6rem; border-radius: 8px;
            font-size: 1.1rem; line-height: 1; display: inline-flex; align-items: center; justify-content: center;
        }
        .refresh-all-btn:hover { color: #fff; border-color: #fff; }
        .refresh-all-btn.spinning { animation: spin 0.5s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .header-center { font-family: 'SF Mono', monospace; font-size: 1.2rem; font-weight: 600; color: var(--accent); letter-spacing: 1px; text-transform: uppercase; }
        .header-right { display: flex; align-items: center; gap: 1.5rem; }
        .status-indicator { display: flex; align-items: center; gap: 0.5rem; padding: 0.4rem 0.8rem; background: var(--accent-dim); border-radius: 20px; font-size: 0.8rem; }
        .status-dot { width: 8px; height: 8px; background: var(--green); border-radius: 50%; animation: pulse 2s ease-in-out infinite; }
        @keyframes pulse { 0%,100% { opacity:1; } 50% { opacity:0.6; } }
        .logo { width: 36px; height: 36px; border-radius: 8px; }
        .brand-name { font-size: 1.1rem; font-weight: 700; letter-spacing: -0.5px; }
        .brand-tagline { font-size: 0.65rem; color: var(--text-dim); }

        /* Status Bar */
        .status-bar {
            display: flex; align-items: center; gap: 0.6rem; padding: 0.3rem 2rem;
            background: rgba(10,10,10,0.95); border-bottom: 1px solid var(--border);
            font-size: 0.7rem;
        }
        .status-bar img { width: 14px; height: 14px; border-radius: 3px; }
        .status-slim-label { font-weight: 700; color: var(--accent); font-size: 0.7rem; }
        .status-slim-pill { color: rgba(255,255,255,0.7); font-weight: 500; }
        .status-slim-pill.green { color: var(--accent); font-weight: 700; }
        .status-slim-pill.red { color: #ef4444; font-weight: 700; }
        .status-slim-pill.dim { color: var(--text-dim); }
        .status-slim-divider { color: rgba(255,255,255,0.2); font-size: 0.5rem; }

        /* Main Layout — Mind dominant, X large sidebar */
        .main-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            padding: 1rem 2rem;
            height: calc(100vh - 56px - 32px);
            overflow: hidden;
        }

        /* Cards */
        .card {
            background: var(--card);
            border: 1px solid rgba(74, 222, 128, 0.25);
            border-radius: 16px;
            padding: 1.25rem;
            box-shadow: 0 8px 32px rgba(0,0,0,0.5), 0 0 8px rgba(74,222,128,0.08);
        }
        .card:hover {
            background: var(--card-hover);
            border-color: rgba(74, 222, 128, 0.4);
        }
        .refresh-btn {
            background: none; border: none; color: var(--accent); cursor: pointer;
            padding: 0.3rem; border-radius: 50%; font-size: 1rem; line-height: 1;
            display: inline-flex; align-items: center; justify-content: center;
        }
        .refresh-btn:hover { color: #fff; text-shadow: 0 0 10px var(--accent); }
        .refresh-btn.spinning { animation: spin 0.6s linear infinite; color: #fff; text-shadow: 0 0 8px var(--accent); }
        .last-refresh { font-size: 0.6rem; color: var(--text-dim); opacity: 0.7; }

        /* LEFT — Jane's Mind (focal) */
        .left-column {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            min-height: 0;
            overflow: hidden;
        }

        /* Mind Widget — FOCAL POINT */
        .mind-widget {
            flex: 1;
            display: flex;
            flex-direction: column;
            border-color: rgba(74, 222, 128, 0.4);
            border-width: 2px;
            box-shadow: 0 8px 40px rgba(0,0,0,0.5), 0 0 20px rgba(74,222,128,0.1), inset 0 0 80px rgba(74,222,128,0.03);
            padding: 1.5rem 1rem 1.5rem 1.5rem;
            min-height: 0;
            overflow-y: auto;
            overflow-x: hidden;
            scrollbar-width: none;
        }
        .mind-widget::-webkit-scrollbar { display: none; }
        .mind-logo { width: 24px; height: 24px; border-radius: 6px; }
        .thinking-header {
            display: flex; align-items: center; gap: 0.5rem;
            margin-bottom: 0.75rem; padding-bottom: 0.5rem;
            border-bottom: 1px solid rgba(74,222,128,0.3);
        }
        .thinking-title {
            font-family: 'SF Mono', monospace; font-size: 1rem; font-weight: 600;
            color: var(--accent); text-transform: uppercase; letter-spacing: 1.5px;
        }
        .thinking-status { margin-left: auto; font-size: 0.75rem; color: var(--green); }
        .mind-model-legend { display: flex; gap: 12px; padding: 4px 0 8px; flex-wrap: wrap; }
        .model-dot { font-size: 0.7rem; color: var(--dot-color, #4ade80); opacity: 0.7; }

        .mind-body {
            display: flex;
            gap: 0.75rem;
            align-items: stretch;
            flex: 1;
            min-height: 0;
            overflow: hidden;
        }

        /* Brain Map — LARGE focal point */
        .brain-map-container {
            flex-shrink: 0;
            width: 440px;
            min-height: 380px;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: -2rem;
            /* no scaleY — diamond shape is native */
        }
        .brain-map-container svg { width: 100%; height: 100%; }

        /* Brain animations — REDESIGNED WAY COOLER */
        /* Breathing scale for idle */
        @keyframes brainBreathe { 0%,100% { transform:scale(0.96); } 50% { transform:scale(1.06); } }
        @keyframes brainActivePulse { 0% { transform:scale(1.0); } 15% { transform:scale(1.045); } 30% { transform:scale(1.025); } 50% { transform:scale(1.04); } 100% { transform:scale(1.04); } }
        @keyframes sonarPing { 0% { r:15; opacity:0.5; stroke-width:3; } 100% { r:280; opacity:0; stroke-width:0.15; } }
        @keyframes hubGlowIdle { 0%,100% { filter:drop-shadow(0 0 6px rgba(74,222,128,0.15)) drop-shadow(0 0 20px rgba(74,222,128,0.05)); } 50% { filter:drop-shadow(0 0 16px rgba(74,222,128,0.3)) drop-shadow(0 0 35px rgba(74,222,128,0.12)); } }
        @keyframes hubGlowActive { 0%,100% { filter:drop-shadow(0 0 12px rgba(74,222,128,0.6)) drop-shadow(0 0 30px rgba(74,222,128,0.3)); } 50% { filter:drop-shadow(0 0 28px rgba(74,222,128,0.9)) drop-shadow(0 0 50px rgba(74,222,128,0.5)); } }
        .brain-map-container { transition: transform 0.3s ease-out; }
        .brain-idle .brain-map-container { animation: brainBreathe 4s ease-in-out infinite; }
        .brain-active .brain-map-container { animation: brainActivePulse 0.4s ease-out forwards; }
        .brain-idle svg { filter: drop-shadow(0 0 6px rgba(74,222,128,0.12)) drop-shadow(0 0 18px rgba(74,222,128,0.04)); }
        .brain-active svg { filter: drop-shadow(0 0 18px rgba(74,222,128,0.4)) drop-shadow(0 0 35px rgba(74,222,128,0.2))!important; }
        .brain-active .sonar-ping { animation: sonarPing 1.5s ease-out infinite; stroke: rgba(74,222,128,0.45); }
        .brain-active .sonar-ping-2 { animation: sonarPing 1.5s ease-out infinite 0.5s; stroke: rgba(74,222,128,0.35); }
        .brain-active .sonar-ping-3 { animation: sonarPing 1.5s ease-out infinite 1s; stroke: rgba(74,222,128,0.25); }
        .brain-idle .sonar-ping, .brain-idle .sonar-ping-2, .brain-idle .sonar-ping-3 { opacity:0; animation:none; }
        @keyframes sciPulse { 0%,100% { opacity:0.12; transform:scale(0.88); } 50% { opacity:0.6; transform:scale(1.25); } }
        @keyframes sciHubPulse { 0%,100% { filter:drop-shadow(0 0 4px rgba(74,222,128,0.2)); stroke-opacity:0.35; } 50% { filter:drop-shadow(0 0 15px rgba(74,222,128,0.6)); stroke-opacity:0.9; } }
        @keyframes hubOuterSpin { 0% { transform:rotate(0deg); } 100% { transform:rotate(360deg); } }
        @keyframes radarSweep { 0% { transform:rotate(0deg); opacity:0.2; } 50% { opacity:0.5; } 100% { transform:rotate(360deg); opacity:0.2; } }
        .hub-outer-ring { transform-origin: 100px 190px; }
        .brain-idle .hub-outer-ring { animation: hubOuterSpin 12s linear infinite; }
        .brain-active .hub-outer-ring { animation: hubOuterSpin 3.5s linear infinite; stroke: rgba(74,222,128,0.7); stroke-width:1.5; }
        @keyframes sciNodePulse { 0%,100% { fill-opacity:0.35; r:2.8; } 50% { fill-opacity:0.85; r:4.5; } }
        @keyframes sciNodeExpand { 0% { r:3; opacity:0.4; } 100% { r:16; opacity:0; } }
        @keyframes sciLinePulse { 0%,100% { stroke-opacity:0.12; } 50% { stroke-opacity:0.35; } }
        @keyframes sciLabelPulse { 0%,100% { fill-opacity:0.45; } 50% { fill-opacity:0.9; } }
        @keyframes sciRingScan { 0% { stroke-dashoffset:0; } 100% { stroke-dashoffset:-628; } }
        @keyframes sciRingScanReverse { 0% { stroke-dashoffset:0; } 100% { stroke-dashoffset:628; } }
        @keyframes sciGridPulse { 0%,100% { stroke-opacity:0.1; } 50% { stroke-opacity:0.22; } }
        .sci-ring { fill:none; stroke:rgba(74,222,128,0.12); stroke-width:0.6; }
        .brain-idle .sci-ring { animation: sciGridPulse 4s ease-in-out infinite; }
        .brain-idle .sci-ring:nth-child(2) { animation-delay:0.8s; }
        .brain-idle .sci-ring:nth-child(3) { animation-delay:1.6s; }
        .sci-scan-ring { fill:none; stroke:rgba(74,222,128,0.22); stroke-width:1; transform-origin:100px 190px; }
        .sci-orbit-1 { stroke-dasharray:25 603; opacity:0.15; }
        .brain-active .sci-orbit-1, .brain-active .sci-orbit-2, .brain-active .sci-orbit-3, .brain-active .sci-orbit-4, .brain-active .sci-orbit-5 { opacity:0.45; stroke-width:1.2; }
        .brain-idle .sci-orbit-1 { animation: sciRingScan 8s linear infinite; }
        .brain-active .sci-orbit-1 { animation: sciRingScan 2.5s linear infinite; stroke:rgba(74,222,128,0.4); }
        .sci-orbit-2 { stroke-dasharray:20 295; opacity:0.12; }
        .brain-idle .sci-orbit-2 { animation: sciRingScanReverse 6s linear infinite; }
        .brain-active .sci-orbit-2 { animation: sciRingScanReverse 2s linear infinite; stroke:rgba(74,222,128,0.4); }
        .sci-orbit-3 { stroke-dasharray:15 236; opacity:0.14; }
        .brain-idle .sci-orbit-3 { animation: sciRingScan 5s linear infinite; }
        .brain-active .sci-orbit-3 { animation: sciRingScan 1.8s linear infinite; stroke:rgba(74,222,128,0.45); }
        .sci-orbit-4 { stroke-dasharray:35 719; opacity:0.12; }
        .brain-idle .sci-orbit-4 { animation: sciRingScanReverse 10s linear infinite; }
        .brain-active .sci-orbit-4 { animation: sciRingScanReverse 3.5s linear infinite; stroke:rgba(74,222,128,0.35); }
        .sci-orbit-5 { stroke-dasharray:18 385; opacity:0.12; }
        .brain-idle .sci-orbit-5 { animation: sciRingScan 7s linear infinite; }
        .brain-active .sci-orbit-5 { animation: sciRingScan 2.5s linear infinite; stroke:rgba(74,222,128,0.4); }
        .brain-idle #brain-glow { animation: sciPulse 4s ease-in-out infinite; transform-origin:100px 190px; }
        .brain-idle #brain-hub { animation: sciHubPulse 5s ease-in-out infinite; }
        .brain-idle .brain-node-circle { animation: sciNodePulse 3.5s ease-in-out infinite; }
        .brain-idle #brain-node-0 { animation-delay:0s; }
        .brain-idle #brain-node-1 { animation-delay:0.5s; }
        .brain-idle #brain-node-2 { animation-delay:1s; }
        .brain-idle #brain-node-3 { animation-delay:1.5s; }
        .brain-idle #brain-node-4 { animation-delay:2s; }
        .brain-idle #brain-node-5 { animation-delay:2.5s; }
        .brain-idle #brain-node-6 { animation-delay:3s; }
        .brain-idle #brain-node-7 { animation-delay:3.5s; }
        .brain-idle .brain-line { animation: sciLinePulse 3.5s ease-in-out infinite; }
        .brain-idle #brain-line-0 { animation-delay:0s; }
        .brain-idle #brain-line-1 { animation-delay:0.5s; }
        .brain-idle #brain-line-2 { animation-delay:1s; }
        .brain-idle #brain-line-3 { animation-delay:1.5s; }
        .brain-idle #brain-line-4 { animation-delay:2s; }
        .brain-idle #brain-line-5 { animation-delay:2.5s; }
        .brain-idle #brain-line-6 { animation-delay:3s; }
        .brain-idle #brain-line-7 { animation-delay:3.5s; }
        .brain-idle .brain-node-label { animation: sciLabelPulse 3.5s ease-in-out infinite, labelFloat 6s ease-in-out infinite; }
        @keyframes labelFloat { 0%,100% { transform:translateY(0); } 50% { transform:translateY(-2px); } }

        /* Pulse waves — ENHANCED */
        @keyframes pulseWaveExpand { 0% { r:22; opacity:0.2; stroke-width:1.5; } 100% { r:260; opacity:0; stroke-width:0.2; } }
        .brain-idle .pulse-wave { animation: pulseWaveExpand 5s ease-out infinite; }
        .brain-idle .pulse-wave-2 { animation-delay:2s; }
        .brain-idle .pulse-wave-3 { animation-delay:4s; }
        .brain-active .pulse-wave { animation: pulseWaveExpand 2.5s ease-out infinite; stroke:rgba(74,222,128,0.25); }
        .brain-active .pulse-wave-2 { animation-delay:0.8s; }
        .brain-active .pulse-wave-3 { animation-delay:1.6s; }

        /* Center brain glow pulse — ENHANCED */
        @keyframes brainCenterGlow { 0%,100% { filter:drop-shadow(0 0 6px rgba(74,222,128,0.15)) drop-shadow(0 0 22px rgba(74,222,128,0.08)); } 50% { filter:drop-shadow(0 0 20px rgba(74,222,128,0.35)) drop-shadow(0 0 45px rgba(74,222,128,0.15)); } }
        @keyframes brainCenterGlowActive { 0%,100% { filter:drop-shadow(0 0 15px rgba(74,222,128,0.5)) drop-shadow(0 0 35px rgba(74,222,128,0.25)); } 50% { filter:drop-shadow(0 0 35px rgba(74,222,128,0.85)) drop-shadow(0 0 65px rgba(74,222,128,0.45)); } }
        .brain-idle #brain-hub-group { animation: brainCenterGlow 4s ease-in-out infinite; }
        .brain-active #brain-hub-group { animation: brainCenterGlowActive 1.2s ease-in-out infinite; }

        /* Energy core pulse in center */
        @keyframes energyCorePulse { 0%,100% { opacity:0.15; r:12; } 50% { opacity:0.4; r:15; } }
        @keyframes energyCoreActive { 0%,100% { opacity:0.35; r:14; } 50% { opacity:0.75; r:18; } }
        .brain-idle .energy-core { animation: energyCorePulse 3s ease-in-out infinite; }
        .brain-active .energy-core { animation: energyCoreActive 1s ease-in-out infinite; fill:rgba(74,222,128,0.3)!important; }

        /* Hex grid fade */
        @keyframes hexFade { 0%,100% { opacity:0.5; } 50% { opacity:0.9; } }
        .hex-bg { animation: hexFade 8s ease-in-out infinite; }

        /* Matrix rain effect */
        @keyframes matrixRain { 0% { opacity:0; transform:translateY(-20px); } 50% { opacity:0.15; } 100% { opacity:0; transform:translateY(60px); } }
        .matrix-char { font-size:6px; fill:rgba(74,222,128,0.4); font-family:'SF Mono',monospace; animation: matrixRain 3s ease-in infinite; }

        /* Dim idle orbit rings */
        .brain-idle .sci-orbit-1 { opacity:0.12; }
        .brain-idle .sci-orbit-2 { opacity:0.10; }
        .brain-idle .sci-orbit-3 { opacity:0.14; }
        .brain-idle .sci-orbit-4 { opacity:0.10; }
        .brain-idle .sci-orbit-5 { opacity:0.12; }
        @keyframes sciHubLogoPulse { 0%,100% { opacity:0.7; } 50% { opacity:1; } }
        .brain-idle #brain-hub-label { animation: sciHubLogoPulse 3.5s ease-in-out infinite; }
        .brain-active #brain-hub-label { opacity:1!important; filter:drop-shadow(0 0 6px rgba(74,222,128,0.5)) drop-shadow(0 0 12px rgba(74,222,128,0.3)); }
        .brain-active #brain-hub { stroke-opacity:1!important; stroke-width:2px!important; filter:drop-shadow(0 0 22px rgba(74,222,128,0.9)) drop-shadow(0 0 10px rgba(74,222,128,0.5))!important; }
        .brain-active #brain-glow { opacity:0.45; }
        .brain-node-circle { transition: all 0.4s ease; }
        .brain-node-label { font-size:8px; font-family:'SF Mono',monospace; letter-spacing:0.8px; text-transform:uppercase; fill:rgba(74,222,128,0.5); text-anchor:middle; pointer-events:none; }
        .brain-line { transition: stroke 0.4s ease; }
        @keyframes pulseDot { 0% { offset-distance:0%; opacity:1; } 100% { offset-distance:100%; opacity:0; } }
        
        /* Radar sweep for outer ring */
        @keyframes radarTicks { 0% { stroke-opacity:0.2; } 50% { stroke-opacity:0.6; } 100% { stroke-opacity:0.2; } }
        .radar-tick { stroke:rgba(74,222,128,0.25); stroke-width:0.8; }
        .brain-active .radar-tick { animation: radarTicks 2s ease-in-out infinite; stroke:rgba(74,222,128,0.4); }
        
        /* Ollama indicator ring segment */
        @keyframes ollamaPulse { 0%,100% { stroke-opacity:0.3; stroke-width:2; } 50% { stroke-opacity:0.8; stroke-width:3; } }
        @keyframes ollamaGlow { 0%,100% { filter:drop-shadow(0 0 4px rgba(249,115,22,0.4)); } 50% { filter:drop-shadow(0 0 12px rgba(249,115,22,0.8)); } }
        .ollama-indicator { stroke:#f97316; fill:none; opacity:0; transition:opacity 0.4s; }
        .ollama-active .ollama-indicator { opacity:1; animation: ollamaPulse 2s ease-in-out infinite, ollamaGlow 2s ease-in-out infinite; }
        
        /* Grok indicator ring segment */
        @keyframes grokPulse { 0%,100% { stroke-opacity:0.3; stroke-width:2; } 50% { stroke-opacity:0.8; stroke-width:3; } }
        @keyframes grokGlow { 0%,100% { filter:drop-shadow(0 0 4px rgba(239,68,68,0.4)); } 50% { filter:drop-shadow(0 0 12px rgba(239,68,68,0.8)); } }
        .grok-indicator { stroke:#ef4444; fill:none; opacity:0; transition:opacity 0.4s; }
        .grok-active .grok-indicator { opacity:1; animation: grokPulse 2s ease-in-out infinite, grokGlow 2s ease-in-out infinite; }
        
        /* Synaptic arcs between nodes when active */
        .synapse-arc { stroke:rgba(74,222,128,0.3); fill:none; stroke-width:0.8; opacity:0; stroke-linecap:round; }
        @keyframes synapseFlash { 0%,100% { opacity:0; } 20%,80% { opacity:0.6; } 50% { opacity:1; } }
        .brain-active .synapse-arc { animation: synapseFlash 2s ease-in-out infinite; }
        
        /* Particle container */
        .brain-particle { opacity:0.6; transition: opacity 0.3s; }
        @keyframes particleFloat { 0% { opacity:0; transform:translate(0,0); } 50% { opacity:0.4; } 100% { opacity:0; transform:translate(var(--px),var(--py)); } }

        /* Mind Info Panel */
        .mind-info {
            flex: 1; min-width: 0;
            display: flex; flex-direction: column; gap: 0.75rem;
            overflow-y: auto; scrollbar-width: none; -ms-overflow-style: none;
        }
        .mind-info::-webkit-scrollbar { display: none; }
        .mind-section {
            padding-bottom: 0.6rem;
            border-bottom: 1px solid rgba(74,222,128,0.12);
        }
        .mind-section:last-child { border-bottom: none; }
        .mind-section-label {
            font-size: 0.75rem; color: var(--text-dim); text-transform: uppercase;
            letter-spacing: 1.2px; margin-bottom: 0.4rem; font-weight: 600;
        }
        .mind-task-text { color: var(--accent); font-weight: 700; font-size: 1.6rem; line-height: 1.3; min-height: 2rem; }
        .mind-thought-text { color: var(--accent); font-size: 1.1rem; font-weight: 700; line-height: 1.4; overflow-y: auto; scrollbar-width: none; -ms-overflow-style: none; }
        .mind-thought-text::-webkit-scrollbar { display: none; }
        .mind-steps { display: flex; flex-direction: column; gap: 0.3rem; scrollbar-width: none; -ms-overflow-style: none; }
        .mind-steps::-webkit-scrollbar { display: none; }
        .mind-step {
            display: flex; align-items: center; gap: 0.5rem;
            padding: 0.45rem 0.7rem; font-size: 1rem; border-radius: 6px;
        }
        .mind-step.pending { color: var(--text-dim); }
        .mind-step.active { color: #4ade80; background: rgba(74,222,128,0.08); }
        .mind-step.done { color: rgba(74,222,128,0.6); }
        .step-indicator { font-size: 0.7rem; flex-shrink: 0; width: 16px; text-align: center; }
        .step-tool {
            font-size: 0.65rem; padding: 1px 6px; border-radius: 3px;
            margin-left: auto; flex-shrink: 0; font-weight: 600; letter-spacing: 0.3px;
        }
        .waiting-dots::after { content:''; animation: dots 1.5s steps(4,end) infinite; }
        @keyframes dots { 0%,20%{content:'';} 40%{content:'.';} 60%{content:'..';} 80%,100%{content:'...';} }

        /* Sub-agent lobsters orbiting brain */
        .sa-orbit-container { position:absolute; inset:0; pointer-events:none; z-index:10; }
        .sa-lobster { position:absolute; width:22px; height:22px; pointer-events:auto; cursor:pointer; transition: opacity 1s ease-out; }
        .sa-lobster.fade-out { opacity:0; }
        .sa-lobster svg { width:100%; height:100%; }
        .sa-lobster-label { position:absolute; top:100%; left:50%; transform:translateX(-50%); font-size:8px; font-weight:600; text-align:center; max-width:80px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; margin-top:1px; pointer-events:none; text-shadow: 0 1px 3px rgba(0,0,0,0.8); }
        @keyframes saFloat { 0%,100% { transform:translateY(0); } 50% { transform:translateY(-4px); } }

        /* Connected Accounts — collapsible */
        .conn-toggle {
            display: flex; align-items: center; justify-content: space-between;
            cursor: pointer; padding: 0.5rem 0.75rem;
        }
        .conn-toggle-title {
            font-size: 0.8rem; font-weight: 700; color: var(--accent);
            display: flex; align-items: center; gap: 0.4rem;
        }
        .conn-arrow { font-size: 0.6rem; color: var(--text-dim); transition: transform 0.3s; }
        .conn-body { display: none; padding: 0.5rem 0.75rem 0.75rem; }
        .conn-body.open { display: block; }

        /* Pop-up overlay panels */
        .popup-backdrop {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.3);
            z-index: 500;
        }
        .popup-backdrop.active { display: block; }
        .popup-panel {
            position: fixed;
            top: 50%; left: 25%;
            transform: translate(-50%, -50%);
            z-index: 501;
            width: min(480px, 90vw);
            max-height: 70vh;
            overflow-y: auto;
            background: rgba(20, 20, 20, 0.98);
            border: 1px solid rgba(74, 222, 128, 0.4);
            border-radius: 16px;
            box-shadow: 0 16px 64px rgba(0,0,0,0.8), 0 0 30px rgba(74,222,128,0.15);
            display: none;
            scrollbar-width: thin;
            scrollbar-color: rgba(74,222,128,0.3) transparent;
        }
        .popup-panel.active { display: block; }
        .popup-panel .popup-close {
            position: sticky; top: 0;
            display: flex; align-items: center; justify-content: space-between;
            padding: 0.75rem 0.75rem 0.5rem;
            background: rgba(20,20,20,0.98);
            z-index: 1;
            border-bottom: 1px solid rgba(74,222,128,0.1);
        }
        .popup-close-btn {
            background: none; border: 1px solid rgba(255,255,255,0.15);
            color: rgba(255,255,255,0.6); cursor: pointer;
            padding: 0.15rem 0.5rem; border-radius: 6px; font-size: 0.7rem;
            transition: all 0.2s;
        }
        .popup-close-btn:hover { color: #fff; border-color: rgba(74,222,128,0.5); }
        .conn-section-title {
            font-size: 0.6rem; text-transform: uppercase; letter-spacing: 0.08em;
            color: var(--text-dim); margin-bottom: 0.25rem; font-weight: 600;
        }
        .conn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0.15rem 0.5rem; }
        .conn-item { display: flex; align-items: center; gap: 0.3rem; padding: 0.15rem 0; font-size: 0.7rem; }
        .conn-item img { width: 14px; height: 14px; border-radius: 2px; }
        .conn-item img.logo-invert { filter: invert(1); }
        .conn-dot { width: 5px; height: 5px; border-radius: 50%; background: var(--accent); margin-left: 2px; }
        .conn-divider { border-top: 1px solid rgba(255,255,255,0.05); margin: 0.35rem 0; }

        /* RIGHT COLUMN — X Widget */
        .right-column {
            display: flex; flex-direction: column; gap: 0.75rem;
            min-height: 0; overflow: hidden;
        }

        /* X Widget — Mobile-inspired */
        .card-x {
            flex: 1; display: flex; flex-direction: column; min-height: 0; overflow: hidden;
        }
        .x-stats-strip {
            display: flex; align-items: center; justify-content: space-evenly;
            gap: 1rem; padding: 0.7rem 1rem; margin-bottom: 0.5rem;
            background: rgba(255,255,255,0.03); border-radius: 8px; flex-shrink: 0;
        }
        .x-strip-stat { font-size: 0.9rem; display: flex; flex-direction: column; align-items: center; gap: 0.15rem; }
        .x-strip-val { color: rgba(255,255,255,0.95); font-weight: 700; font-size: 1.1rem; font-variant-numeric: tabular-nums; }
        .x-strip-lbl { color: rgba(255,255,255,0.4); font-weight: 500; font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.03em; }
        .x-strip-delta { font-size: 0.7rem; font-weight: 600; }
        .x-strip-delta.up { color: #4ade80; }
        .x-strip-delta.down { color: #ef4444; }
        .x-strip-delta.flat { color: rgba(255,255,255,0.2); }
        .x-plan-dot { width: 6px; height: 6px; border-radius: 50%; display: inline-block; }
        .x-thread-nav {
            display: flex; align-items: center; justify-content: center;
            gap: 0.5rem; margin-bottom: 0.5rem; flex-shrink: 0;
        }
        .x-thread-nav-btn {
            font-size: 0.8rem; color: rgba(255,255,255,0.25); cursor: pointer;
            padding: 0 0.3rem; user-select: none;
        }
        .x-thread-nav-btn:hover { color: rgba(255,255,255,0.5); }
        .x-tweet-feed {
            display: flex; flex-direction: column; gap: 0.5rem;
            overflow-y: auto; flex: 1; min-height: 0;
        }
        .x-tweet-item {
            padding: 0.75rem 0.8rem; background: rgba(255,255,255,0.03);
            border-radius: 8px; border-left: 2px solid rgba(255,255,255,0.08);
        }
        .x-tweet-item:first-child { border-left-color: #4ade80; }
        .x-tweet-meta { display: flex; justify-content: space-between; align-items: center; margin-bottom: 3px; }
        .x-tweet-text { font-size: 1.05rem; color: rgba(255,255,255,0.85); line-height: 1.5; white-space: pre-wrap; }
        .x-tweet-stat { font-size: 0.7rem; color: rgba(255,255,255,0.3); }

        /* Sorare Widget — hidden on desktop, mobile only */
        .card-sorare { padding: 0.75rem 1rem; background: linear-gradient(135deg, rgba(255,215,0,0.03) 0%, transparent 50%); display: none; }
        .sorare-status-bar {
            display: flex; justify-content: space-between; align-items: center;
            padding: 0.4rem 0.6rem; background: rgba(255,215,0,0.08);
            border: 1px solid rgba(255,215,0,0.2); border-radius: 8px; margin-bottom: 0.5rem;
        }
        .sorare-gw { font-weight: 700; color: #ffd700; font-size: 0.85rem; }
        .sorare-countdown { font-size: 0.7rem; }
        .sorare-countdown.live { color: #4ade80; }
        .sorare-countdown.ending { color: #f97316; }
        .sorare-status-badge { font-size: 0.6rem; padding: 0.15rem 0.5rem; border-radius: 4px; text-transform: uppercase; font-weight: 600; }
        .sorare-status-badge.scheduled { background: rgba(100,100,100,0.3); color: #888; }
        .sorare-status-badge.live { background: rgba(74,222,128,0.2); color: #4ade80; }
        .sorare-status-badge.ending { background: rgba(249,115,22,0.2); color: #f97316; }
        .sorare-status-badge.final { background: rgba(255,215,0,0.2); color: #ffd700; }
        .sorare-lineups { display: flex; flex-direction: column; gap: 0.4rem; margin-bottom: 0.5rem; }
        .sorare-lineup-card { background: rgba(255,255,255,0.03); border: 1px solid var(--border); border-radius: 8px; padding: 0.4rem 0.5rem; }
        .sorare-lineup-card.live { border-color: rgba(74,222,128,0.3); }
        .sorare-lineup-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.3rem; }
        .sorare-lineup-num { font-weight: 700; color: #ffd700; font-size: 0.75rem; }
        .sorare-lineup-rank { font-size: 0.65rem; color: var(--accent); font-weight: 600; }
        .sorare-lineup-score { font-size: 0.7rem; color: var(--text); font-weight: 600; }
        .sorare-lineup-players { display: flex; flex-wrap: wrap; gap: 0.2rem; font-size: 0.55rem; color: var(--text-dim); }
        .sorare-player { background: rgba(255,255,255,0.05); padding: 0.1rem 0.35rem; border-radius: 4px; }
        .sorare-player.playing { background: rgba(74,222,128,0.15); color: #4ade80; }
        .sorare-player.final { color: var(--text); }
        .sorare-summary {
            display: flex; justify-content: space-between; align-items: center;
            padding: 0.3rem 0.5rem; background: rgba(255,255,255,0.02); border-radius: 6px; font-size: 0.65rem;
        }
        .sorare-summary-item { text-align: center; }
        .sorare-summary-value { font-weight: 700; color: #ffd700; }
        .sorare-summary-label { font-size: 0.55rem; color: var(--text-dim); text-transform: uppercase; }

        /* Active Trades Widget */
        .trades-card {
            background: linear-gradient(135deg, rgba(74,222,128,0.10) 0%, rgba(74,222,128,0.02) 100%);
            border: 1px solid rgba(74,222,128,0.25); border-radius: 12px; overflow: hidden;
        }
        .trades-header {
            display: flex; align-items: center; justify-content: space-between;
            cursor: pointer; padding: 0.65rem 1rem; transition: background 0.2s;
        }
        .trades-header:hover { background: rgba(74,222,128,0.06); }
        .trades-header-left { display: flex; align-items: center; gap: 0.5rem; }
        .trades-header-title { font-size: 0.8rem; font-weight: 700; color: var(--text); }
        .trades-header-budget { font-size: 0.7rem; color: var(--accent); font-weight: 600; }
        .trades-arrow { font-size: 0.7rem; color: var(--text-dim); transition: transform 0.2s; }
        .trades-arrow.open { transform: rotate(90deg); }
        .trades-body { max-height: 0; overflow: hidden; transition: max-height 0.3s ease; padding: 0 1rem; }
        .trades-body.open { max-height: 600px; padding: 0.5rem 1rem 0.75rem; }
        .trades-budget-bar { display: flex; gap: 0.5rem; margin-bottom: 0.5rem; font-size: 0.65rem; }
        .trades-budget-pill { padding: 0.15rem 0.5rem; border-radius: 4px; font-weight: 600; }
        .trades-section-label { font-size: 0.6rem; text-transform: uppercase; letter-spacing: 1px; color: var(--text-dim); font-weight: 600; margin-bottom: 0.3rem; }
        .trades-pos-row {
            display: flex; align-items: center; justify-content: space-between;
            padding: 0.35rem 0.5rem; background: rgba(255,255,255,0.03);
            border-radius: 6px; margin-bottom: 0.25rem; font-size: 0.72rem;
        }
        .trades-pos-token { font-weight: 700; color: var(--text); min-width: 60px; }
        .trades-pos-pnl { font-weight: 700; min-width: 50px; text-align: right; }
        .trades-pos-pnl.green { color: var(--green); }
        .trades-pos-pnl.red { color: var(--red); }
        .trades-pos-meta { color: var(--text-dim); font-size: 0.6rem; }
        .trades-closed-row {
            display: flex; align-items: center; justify-content: space-between;
            padding: 0.25rem 0.5rem; font-size: 0.65rem; opacity: 0.7;
        }

        /* Coinbase Wallet Widget — Modern Card UI */
        .wallet-card {
            background: var(--card);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 12px;
            overflow: hidden;
            padding: 0;
        }
        .wallet-header {
            display: flex; align-items: center; justify-content: space-between;
            cursor: pointer; padding: 0.5rem 0.75rem;
            transition: background 0.2s;
        }
        .wallet-header:hover { background: rgba(74,222,128,0.04); }
        .wallet-header-left {
            display: flex; align-items: center; gap: 0.5rem;
        }
        .wallet-cb-logo {
            width: 20px; height: 20px; border-radius: 50%;
            background: #4ade80; display: flex; align-items: center; justify-content: center;
            flex-shrink: 0; padding: 3px;
        }
        .wallet-cb-logo svg { width: 100%; height: 100%; }
        .wallet-header-info { display: flex; align-items: center; gap: 0.5rem; }
        .wallet-header-title { font-size: 0.8rem; font-weight: 700; color: #4ade80; }
        .wallet-header-bal { font-size: 0.85rem; font-weight: 700; color: #fff; }
        .wallet-arrow {
            font-size: 0.55rem; color: rgba(255,255,255,0.4); transition: transform 0.35s cubic-bezier(0.4,0,0.2,1);
        }
        .wallet-body {
            max-height: 0; overflow: hidden;
            transition: max-height 0.4s cubic-bezier(0.4,0,0.2,1), padding 0.3s;
            padding: 0 1rem;
        }
        .wallet-body.open {
            max-height: 800px;
            padding: 0 1rem 0.75rem;
        }
        /* Compact trades summary — visible when collapsed */
        .wallet-trades-compact {
            padding: 0 1rem 0.5rem;
            display: flex; flex-direction: column; gap: 2px;
        }
        .wallet-trades-compact:empty { padding: 0; }
        .wallet-compact-trade {
            display: flex; align-items: center; justify-content: space-between;
            font-size: 0.68rem; padding: 0.2rem 0.4rem;
            background: rgba(255,255,255,0.02); border-radius: 4px;
        }
        .wallet-compact-trade .wct-token { font-weight: 700; color: var(--text); min-width: 50px; }
        .wallet-compact-trade .wct-prices { color: var(--text-dim); }
        .wallet-compact-trade .wct-pnl { font-weight: 700; min-width: 45px; text-align: right; }
        .wallet-compact-trade .wct-pnl.green { color: var(--green); }
        .wallet-compact-trade .wct-pnl.red { color: var(--red); }
        .wallet-chains { display: flex; flex-direction: column; gap: 0.5rem; }
        .wallet-chain-card {
            background: rgba(255,255,255,0.04);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 10px; padding: 0.6rem 0.75rem;
            transition: border-color 0.2s;
        }
        .wallet-chain-card:hover { border-color: rgba(74,222,128,0.35); }
        .wallet-chain-top {
            display: flex; align-items: center; justify-content: space-between;
            margin-bottom: 0.35rem;
        }
        .wallet-chain-id {
            display: flex; align-items: center; gap: 0.4rem;
        }
        .wallet-chain-icon {
            width: 22px; height: 22px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 0.65rem; font-weight: 800; flex-shrink: 0;
        }
        .wallet-chain-icon.base { background: #4ade80; color: #0a0a0a; }
        .wallet-chain-icon.solana { background: linear-gradient(135deg, #9945FF, #14F195); color: #fff; }
        .wallet-chain-label { font-size: 0.72rem; font-weight: 700; color: var(--text); }
        .wallet-chain-usd { font-size: 0.75rem; font-weight: 700; color: #0052FF; }
        .wallet-addr-row {
            display: flex; align-items: center; gap: 0.3rem;
            font-family: 'SF Mono', monospace; font-size: 0.62rem; color: rgba(255,255,255,0.35);
            margin-bottom: 0.3rem;
        }
        .wallet-copy-btn {
            background: none; border: 1px solid rgba(255,255,255,0.1); color: var(--text-dim); cursor: pointer;
            font-size: 0.55rem; padding: 2px 6px; border-radius: 4px; transition: all 0.2s;
        }
        .wallet-copy-btn:hover { color: #0052FF; border-color: rgba(0,82,255,0.4); background: rgba(0,82,255,0.08); }
        .wallet-token-row {
            display: flex; align-items: center; justify-content: space-between;
            padding: 0.25rem 0; font-size: 0.7rem;
        }
        .wallet-token-left { display: flex; align-items: center; gap: 0.35rem; }
        .wallet-token-dot { width: 6px; height: 6px; border-radius: 50%; flex-shrink: 0; }
        .wallet-token-dot.sol { background: linear-gradient(135deg, #9945FF, #14F195); }
        .wallet-token-dot.eth { background: #627EEA; }
        .wallet-token-name { color: var(--text); font-weight: 600; }
        .wallet-token-amt { color: var(--text-dim); font-variant-numeric: tabular-nums; font-size: 0.65rem; }
        .wallet-token-usd { color: #0052FF; font-weight: 700; font-variant-numeric: tabular-nums; }
        .wallet-empty { font-size: 0.62rem; color: rgba(255,255,255,0.25); font-style: italic; padding: 0.15rem 0; }
        .wallet-footer {
            display: flex; align-items: center; justify-content: space-between;
            padding-top: 0.4rem; margin-top: 0.35rem;
            border-top: 1px solid rgba(255,255,255,0.06);
        }
        .wallet-updated { font-size: 0.52rem; color: rgba(255,255,255,0.25); }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-dim); }

        /* Night Mode */
        .night-mode-overlay {
            display: none; position: fixed; top: 0; left: 0;
            width: 100vw; height: 100vh; background: #000; z-index: 9999;
            flex-direction: column; justify-content: center; align-items: center; cursor: pointer;
        }
        .night-mode-overlay.active { display: flex; }
        .eink-time { font-family: 'SF Mono', monospace; font-size: 18rem; font-weight: 600; color: #0d2818; line-height: 1; }
        .eink-ampm { font-family: 'SF Mono', monospace; font-size: 2.5rem; font-weight: 600; color: #091a10; margin-top: 0.5rem; }
        .eink-date { font-family: 'SF Mono', monospace; font-size: 1.8rem; font-weight: 600; color: #091a10; margin-top: 1.5rem; text-transform: uppercase; }
        .eink-hint { position: absolute; bottom: 2rem; font-family: 'SF Mono', monospace; font-size: 0.7rem; color: #080808; text-transform: uppercase; letter-spacing: 1px; }
        .bouncing-logo { position: absolute; width: 120px; height: 120px; opacity: 0.12; }
        .bouncing-logo img { width: 100%; height: 100%; border-radius: 16px; }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-left">
            <div style="display:flex;align-items:center;gap:2rem;">
                <svg viewBox="0 0 120 120" fill="none" xmlns="http://www.w3.org/2000/svg" class="oc-logo-animated" style="width:36px;height:36px;flex-shrink:0;"><defs><linearGradient id="oc-grad" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="#ff4d4d"/><stop offset="100%" stop-color="#991b1b"/></linearGradient></defs><path d="M60 10C30 10 15 35 15 55C15 75 30 95 45 100L45 110 55 110 55 100C55 100 60 102 65 100L65 110 75 110 75 100C90 95 105 75 105 55C105 35 90 10 60 10Z" fill="url(#oc-grad)"/><path d="M20 45C5 40 0 50 5 60C10 70 20 65 25 55C28 48 25 45 20 45Z" fill="url(#oc-grad)"/><path d="M100 45C115 40 120 50 115 60C110 70 100 65 95 55C92 48 95 45 100 45Z" fill="url(#oc-grad)"/><path d="M45 15Q35 5 30 8" stroke="#ff4d4d" stroke-width="3" stroke-linecap="round"/><path d="M75 15Q85 5 90 8" stroke="#ff4d4d" stroke-width="3" stroke-linecap="round"/><circle cx="45" cy="35" r="6" fill="#050810"/><circle cx="75" cy="35" r="6" fill="#050810"/><circle cx="46" cy="34" r="2.5" fill="#00e5cc"/><circle cx="76" cy="34" r="2.5" fill="#00e5cc"/></svg>
                <div>
                <div class="header-time" id="current-time">--:--</div>
                <div class="header-date" id="current-date">---</div>
                </div>
            </div>
            <button class="night-mode-btn" onclick="toggleNightMode()">NIGHT<br>MODE</button>
            <button class="refresh-all-btn" id="refresh-all-btn" onclick="refreshAll()" title="Refresh all widgets">↻</button>
        </div>
        <div class="header-center">hi Josh</div>
        <div class="header-right">
            <div class="status-indicator">
                <span class="status-dot"></span>
                <span id="system-status">Online</span>
            </div>
            <img src="icon-192.png" alt="Jane" class="logo">
            <div>
                <span class="brand-name">JANE</span><br>
                <span class="brand-tagline">Personal AI</span>
            </div>
        </div>
    </header>

    <!-- Status Bar -->
    <div class="status-bar">
        <img src="icon-192.png" alt="Jane">
        <span class="status-slim-label">Jane</span>
        <span class="status-slim-pill dim" id="jane-age-slim">Age: --</span>
        <span class="status-slim-divider">·</span>
        <span class="status-slim-pill" id="cpu-slim">CPU: --%</span>
        <span class="status-slim-divider">·</span>
        <span class="status-slim-pill" id="ram-slim">RAM: --%</span>
        <span class="status-slim-divider">·</span>
        <span class="status-slim-pill green" id="mini1-slim" title="Mac Mini #1 (Main)">Mini1: ✓</span>
        <span class="status-slim-divider">·</span>
        <span class="status-slim-pill" id="mini2-slim" title="Mac Mini #2">Mini2: --</span>
        <span class="status-slim-divider">·</span>
        <span class="status-slim-pill" id="ctx-slim" title="Context window usage">Ctx: --%</span>
        <span class="status-slim-divider">·</span>
        <span class="status-slim-pill" id="session-limit-slim" title="Anthropic session usage limit">Sess: --%</span>
        <span class="status-slim-divider">·</span>
        <span class="status-slim-pill" id="weekly-limit-slim" title="Anthropic weekly usage limit">Wk: --%</span>
    </div>

    <!-- Main Grid -->
    <!-- Pop-up backdrop -->
    <div class="popup-backdrop" id="popup-backdrop"></div>
    <!-- Pop-up panels for Wallet, Jobs, Accounts -->
    <div class="popup-panel" id="wallet-popup">
        <div class="popup-close">
            <span style="font-size:0.85rem;font-weight:700;color:#4ade80;flex:1;padding-left:0.25rem;">
                <svg style="display:inline-block;vertical-align:middle;width:14px;height:14px;margin-right:4px;" viewBox="0 0 24 24" fill="none" stroke="#4ade80" stroke-width="2"><rect x="2" y="6" width="20" height="14" rx="3"/><path d="M16 12h2v4h-2z" fill="#4ade80"/><path d="M6 6V4a2 2 0 012-2h8a2 2 0 012 2v2"/></svg>
                MyWallet
            </span>
            <button class="popup-close-btn" onclick="closePopup('wallet')">✕</button>
        </div>
        <div id="wallet-popup-content" style="padding:0 1rem 0.75rem;"></div>
    </div>
    <div class="popup-panel" id="jobs-popup">
        <div class="popup-close">
            <span style="font-size:0.85rem;font-weight:700;color:#4ade80;flex:1;padding-left:0.25rem;">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="#4ade80" style="display:inline-block;vertical-align:middle;margin-right:4px;"><rect x="4" y="8" width="16" height="12" rx="3"/><circle cx="9" cy="14" r="1.5" fill="#1a1a2e"/><circle cx="15" cy="14" r="1.5" fill="#1a1a2e"/><line x1="12" y1="5" x2="12" y2="8" stroke="#4ade80" stroke-width="2"/><circle cx="12" cy="4" r="2" fill="#4ade80"/></svg>
                Today's Jobs
            </span>
            <button class="popup-close-btn" onclick="closePopup('jobs')">✕</button>
        </div>
        <div id="jobs-popup-content" style="padding:0 0.75rem 0.6rem;"></div>
    </div>
    <div class="popup-panel" id="conn-popup">
        <div class="popup-close">
            <span style="font-size:0.85rem;font-weight:700;color:#4ade80;flex:1;padding-left:0.25rem;">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="#4ade80" style="display:inline-block;vertical-align:middle;margin-right:4px;"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76 0 5-2.24 5-5s-2.24-5-5-5z"/></svg>
                Connected Accounts
            </span>
            <button class="popup-close-btn" onclick="closePopup('conn')">✕</button>
        </div>
        <div id="conn-popup-content" style="padding:0.5rem 0.75rem 0.75rem;"></div>
    </div>

    <main class="main-container">
        <!-- LEFT: Jane's Mind + Connected Accounts -->
        <div class="left-column">
            <!-- Jane's Mind — FOCAL POINT -->
            <div class="mind-widget">
                <div class="thinking-header">
                    <img src="icon-192.png" alt="Jane" class="mind-logo">
                    <span class="thinking-title">Jane's Mind</span>
                    <span class="thinking-status" id="mind-status">● Active</span>
                    <button class="refresh-btn" onclick="refreshMind(this)" style="margin-left:auto;">↻</button>
                </div>
                <!-- subagent lobsters rendered inside brain-map-container -->
                <div class="mind-model-legend" id="mind-model-legend">
                    <span class="model-dot" id="model-opus" style="--dot-color:#4ade80;opacity:0.4">● Opus</span>
                    <span class="model-dot" id="model-sonnet" style="--dot-color:#a78bfa;opacity:0.4">● Sonnet</span>
                    <span class="model-dot" id="model-whisper" style="--dot-color:#facc15;opacity:0.4">● Whisper</span>
                    <span class="model-dot" id="model-ollama" style="--dot-color:#f97316;opacity:0.4;font-weight:700">● Ollama</span>
                    <span class="model-dot" id="model-grok" style="--dot-color:#ef4444;opacity:0.4;font-weight:700">● Grok</span>
                    <span class="model-dot" id="model-qwen" style="--dot-color:#06b6d4;opacity:0.4">● Qwen</span>
                    <span class="model-dot" id="model-phi" style="--dot-color:#ec4899;opacity:0.4">● Phi-4</span>
                </div>
                <div class="mind-body" style="flex-direction: row-reverse;">
                    <!-- Brain Map SVG -->
                    <div class="brain-map-container" style="position:relative;">
                        <div class="sa-orbit-container" id="sa-orbit"></div>
                        <svg id="brain-map" viewBox="-10 20 220 380" xmlns="http://www.w3.org/2000/svg">
                            <defs>
                                <radialGradient id="hubGlow" cx="50%" cy="50%" r="50%">
                                    <stop offset="0%" stop-color="rgba(74,222,128,0.2)"/>
                                    <stop offset="100%" stop-color="rgba(74,222,128,0)"/>
                                </radialGradient>
                                <radialGradient id="energyCore" cx="50%" cy="50%" r="50%">
                                    <stop offset="0%" stop-color="rgba(74,222,128,0.4)"/>
                                    <stop offset="70%" stop-color="rgba(74,222,128,0.15)"/>
                                    <stop offset="100%" stop-color="rgba(74,222,128,0)"/>
                                </radialGradient>
                                <filter id="energyGlow">
                                    <feGaussianBlur stdDeviation="3" result="coloredBlur"/>
                                    <feMerge>
                                        <feMergeNode in="coloredBlur"/>
                                        <feMergeNode in="SourceGraphic"/>
                                    </feMerge>
                                </filter>
                            </defs>
                            <!-- Matrix rain background -->
                            <g id="matrix-rain" opacity="0.08"></g>
                            <circle cx="100" cy="190" r="45" fill="url(#hubGlow)" opacity="0.2" id="brain-glow"/>
                            <!-- Energy core pulsing in center -->
                            <circle cx="100" cy="190" r="12" fill="url(#energyCore)" class="energy-core" filter="url(#energyGlow)"/>
                            <circle cx="100" cy="190" r="50" class="sci-ring"/>
                            <circle cx="100" cy="190" r="100" class="sci-ring"/>
                            <circle cx="100" cy="190" r="150" class="sci-ring"/>
                            <line x1="100" y1="60" x2="100" y2="320" stroke="rgba(74,222,128,0.04)" stroke-width="0.6"/>
                            <line x1="10" y1="190" x2="190" y2="190" stroke="rgba(74,222,128,0.04)" stroke-width="0.6"/>
                            <circle cx="100" cy="190" r="100" class="sci-scan-ring sci-orbit-1"/>
                            <circle cx="100" cy="190" r="50" class="sci-scan-ring sci-orbit-2"/>
                            <circle cx="100" cy="190" r="40" class="sci-scan-ring sci-orbit-3"/>
                            <circle cx="100" cy="190" r="120" class="sci-scan-ring sci-orbit-4"/>
                            <circle cx="100" cy="190" r="64" class="sci-scan-ring sci-orbit-5"/>
                            <!-- Pulse waves radiating from center -->
                            <circle cx="100" cy="190" r="30" class="pulse-wave pulse-wave-1" fill="none" stroke="rgba(74,222,128,0.1)" stroke-width="0.6"/>
                            <circle cx="100" cy="190" r="30" class="pulse-wave pulse-wave-2" fill="none" stroke="rgba(74,222,128,0.08)" stroke-width="0.6"/>
                            <circle cx="100" cy="190" r="30" class="pulse-wave pulse-wave-3" fill="none" stroke="rgba(74,222,128,0.06)" stroke-width="0.6"/>
                            <circle cx="100" cy="190" r="15" class="sonar-ping" fill="none" stroke="rgba(74,222,128,0.3)" stroke-width="2"/>
                            <circle cx="100" cy="190" r="15" class="sonar-ping sonar-ping-2" fill="none" stroke="rgba(74,222,128,0.22)" stroke-width="1.5"/>
                            <circle cx="100" cy="190" r="15" class="sonar-ping sonar-ping-3" fill="none" stroke="rgba(74,222,128,0.15)" stroke-width="1.2"/>
                            <!-- Hex grid background pattern -->
                            <pattern id="hexGrid" width="20" height="17.32" patternUnits="userSpaceOnUse" patternTransform="translate(100,190)">
                                <path d="M10 0 L20 5.77 L20 11.55 L10 17.32 L0 11.55 L0 5.77 Z" fill="none" stroke="rgba(74,222,128,0.04)" stroke-width="0.35"/>
                            </pattern>
                            <circle cx="100" cy="190" r="160" fill="url(#hexGrid)" class="hex-bg"/>
                            <!-- Synaptic arcs container -->
                            <g id="brain-synapses"></g>
                            <g id="brain-lines"></g>
                            <!-- Particle effects container -->
                            <g id="brain-particles"></g>
                            <g id="brain-pulses"></g>
                            <g id="brain-nodes"></g>
                            <g id="brain-hub-group">
                                <!-- Outer radar ring with ticks -->
                                <circle cx="100" cy="190" r="32" fill="none" stroke="rgba(74,222,128,0.15)" stroke-width="0.5" class="radar-outer"/>
                                <!-- Radar tick marks -->
                                <g id="radar-ticks"></g>
                                <!-- Ollama indicator arc (shows when Ollama is active) -->
                                <path id="ollama-indicator" class="ollama-indicator" d="M 100,158 A 32,32 0 0,1 127,171" stroke-width="2.5" stroke-linecap="round"/>
                                <!-- Grok indicator arc (shows when Grok is active) -->
                                <path id="grok-indicator" class="grok-indicator" d="M 100,158 A 32,32 0 0,0 73,171" stroke-width="2.5" stroke-linecap="round"/>
                                <circle cx="100" cy="190" r="24" fill="rgba(74,222,128,0.08)" stroke="rgba(74,222,128,0.3)" stroke-width="0.6" stroke-dasharray="4 4" class="hub-outer-ring" id="hub-outer-ring"/>
                                <circle cx="100" cy="190" r="18" fill="#0a0a0a" stroke="rgba(74,222,128,0.45)" stroke-width="1.2" id="brain-hub" class="brain-hub"/>
                                <image href="icon-192.png" x="86" y="176" width="28" height="28" id="brain-hub-label" opacity="0.8"/>
                            </g>
                        </svg>
<!-- sub-agent box moved to header area -->
                    </div>
                    <!-- Info Panel -->
                    <div class="mind-info">
                        <div class="mind-section">
                            <div class="mind-section-label">GOAL / OBJECTIVE</div>
                            <div class="mind-task-text" id="mind-current-task">Awaiting instructions...</div>
                        </div>
                        <div class="mind-section" style="flex:1;display:flex;flex-direction:column;">
                            <div class="mind-section-label">THINKING, DECISIONS &amp; ACTIONS</div>
                            <div class="mind-thought-text" id="mind-thought-text" style="font-style:normal;">Ready for your next request.</div>
                            <div class="mind-steps" id="mind-steps" style="flex:1;overflow-y:auto;scrollbar-width:none;-ms-overflow-style:none;font-size:0.75rem;margin-top:0.3rem;"></div>
                        </div>
                        <!-- sub-agent indicator -->
                    </div>
                </div>
            </div>

            <!-- Coinbase Wallet + Trades — merged card -->
            <div class="wallet-card">
                <div class="wallet-header" id="wallet-toggle">
                    <div class="wallet-header-left">
                        <div class="wallet-cb-logo"><svg viewBox="0 0 24 24" fill="none" stroke="#0a0a0a" stroke-width="2"><rect x="2" y="6" width="20" height="14" rx="3"/><path d="M16 12h2v4h-2z" fill="#0a0a0a"/><path d="M6 6V4a2 2 0 012-2h8a2 2 0 012 2v2"/></svg></div>
                        <div class="wallet-header-info">
                            <span class="wallet-header-title"><svg style="display:inline-block;vertical-align:middle;width:14px;height:14px;margin-right:4px;" viewBox="0 0 24 24" fill="none" stroke="#4ade80" stroke-width="2"><rect x="2" y="6" width="20" height="14" rx="3"/><path d="M16 12h2v4h-2z" fill="#4ade80"/><path d="M6 6V4a2 2 0 012-2h8a2 2 0 012 2v2"/></svg> MyWallet</span>
                            <span class="wallet-header-bal" id="wallet-total-bal">$0.00</span>
                        </div>
                    </div>
                    <div style="display:flex;align-items:center;gap:0.4rem;">
                        <button class="refresh-btn" onclick="event.stopPropagation();refreshWallet(this)">↻</button>
                        <span class="wallet-arrow" id="wallet-arrow">▶</span>
                    </div>
                </div>
                <!-- Compact trades visible when collapsed -->
                <div class="wallet-trades-compact" id="wallet-trades-compact"></div>
                <div class="wallet-body" id="wallet-body">
                    <div class="wallet-chains" id="wallet-content"><span class="wallet-empty">Loading...</span></div>
                    <!-- Budget bar -->
                    <div class="trades-budget-bar" id="trades-budget-bar" style="margin-top:0.5rem;"></div>
                    <!-- Open Positions -->
                    <div class="trades-section-label" style="margin-top:0.5rem;">Open Positions</div>
                    <div id="trades-open"><span style="color:var(--text-dim);font-size:0.75rem;">No open positions</span></div>
                    <!-- Closed Trades -->
                    <div class="trades-section-label" style="margin-top:0.6rem;">Closed Trades</div>
                    <div id="trades-closed"><span style="color:var(--text-dim);font-size:0.75rem;">No closed trades</span></div>
                </div>
            </div>

            <!-- Today's Jobs — collapsible -->
            <div class="card" style="padding:0;" id="todays-jobs-card">
                <div id="jobs-toggle" style="display:flex;align-items:center;justify-content:space-between;cursor:pointer;padding:0.5rem 0.75rem;">
                    <span style="font-size:0.8rem;font-weight:700;color:#4ade80;display:flex;align-items:center;gap:6px;">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="#4ade80"><rect x="4" y="8" width="16" height="12" rx="3"/><circle cx="9" cy="14" r="1.5" fill="#1a1a2e"/><circle cx="15" cy="14" r="1.5" fill="#1a1a2e"/><line x1="12" y1="5" x2="12" y2="8" stroke="#4ade80" stroke-width="2"/><circle cx="12" cy="4" r="2" fill="#4ade80"/><line x1="2" y1="13" x2="4" y2="13" stroke="#4ade80" stroke-width="2"/><line x1="20" y1="13" x2="22" y2="13" stroke="#4ade80" stroke-width="2"/></svg>
                        Today's Jobs
                        <span id="jobs-count" style="font-size:0.7rem;font-weight:600;color:rgba(255,255,255,0.5);margin-left:4px;">--</span>
                    </span>
                    <span id="jobs-arrow" style="font-size:0.6rem;color:rgba(255,255,255,0.4);transition:transform 0.2s;">▶</span>
                </div>
                <div id="jobs-body" style="display:none;padding:0 0.75rem 0.6rem;"></div>
            </div>

            <!-- Connected Accounts — collapsible dropdown -->
            <div class="card" style="padding:0;">
                <div class="conn-toggle" id="conn-toggle">
                    <span class="conn-toggle-title">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="var(--accent)"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76 0 5-2.24 5-5s-2.24-5-5-5z"/></svg>
                        Connected Accounts
                        <span class="last-refresh" id="connections-refresh">--</span>
                    </span>
                    <button class="refresh-btn" onclick="event.stopPropagation();refreshConnections(this)" style="margin-left:auto;margin-right:8px;">↻</button>
                    <span class="conn-arrow" id="conn-arrow">▶</span>
                </div>
                <div class="conn-body" id="conn-body">
                    <div class="conn-section-title">My Accounts</div>
                    <div class="conn-grid" id="conn-accounts"></div>
                    <div class="conn-divider"></div>
                    <div class="conn-section-title">Data Connections</div>
                    <div class="conn-grid" id="conn-datasources"></div>
                    <div id="conn-newsletters-section" style="display:none;">
                        <div class="conn-divider"></div>
                        <div class="conn-section-title"><svg style="display:inline-block;vertical-align:middle;width:14px;height:14px;margin-right:4px;" viewBox="0 0 24 24" fill="none" stroke="#06b6d4" stroke-width="2"><rect x="2" y="4" width="20" height="16" rx="2"/><polyline points="22 4 12 13 2 4"/></svg> Newsletters</div>
                        <div class="conn-grid" id="conn-newsletters"></div>
                    </div>
                    <div id="conn-podcasts-section" style="display:none;">
                        <div class="conn-divider"></div>
                        <div class="conn-section-title"><svg style="display:inline-block;vertical-align:middle;width:14px;height:14px;margin-right:4px;" viewBox="0 0 24 24" fill="none" stroke="#a855f7" stroke-width="2"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg> Podcasts (14)</div>
                        <div class="conn-grid" id="conn-podcasts"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- RIGHT: X Widget + Sorare -->
        <div class="right-column">
            <!-- X Widget -->
            <div class="card card-x">
                <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:0.5rem;">
                    <div style="display:flex;align-items:center;gap:8px;">
                        <img id="x-profile-pic" src="x-pfp.jpg" alt="X" style="width:52px;height:52px;border-radius:50%;border:2px solid var(--accent);object-fit:cover;">
                        <span style="font-weight:600;font-size:0.95rem;">JCAgentleman</span>
                        <span class="last-refresh" id="x-refresh">--</span>
                    </div>
                    <button class="refresh-btn" onclick="refreshXStats(this);refreshDesktopTweetFeed()">↻</button>
                </div>
                <!-- Stats Strip -->
                <div class="x-stats-strip">
                    <span class="x-strip-stat" id="x-followers"><span class="x-strip-val">--</span> <span class="x-strip-lbl">Followers</span> <span class="x-strip-delta" id="x-d-followers"></span></span>
                    <span class="x-strip-stat" id="x-impressions"><span class="x-strip-val">--</span> <span class="x-strip-lbl">Impressions</span> <span class="x-strip-delta" id="x-d-impressions"></span></span>
                    <span class="x-strip-stat" id="x-engagement"><span class="x-strip-val" style="color:#4ade80;">--</span> <span class="x-strip-lbl">Engagement</span></span>
                    <span class="x-strip-stat" id="x-likes"><span class="x-strip-val">--</span> <span class="x-strip-lbl">likes</span> <span class="x-strip-delta" id="x-d-likes"></span></span>
                </div>
                <div id="x-content-plan" style="display:flex;align-items:center;gap:0.75rem;padding:0.35rem 0.5rem;font-size:0.7rem;border-top:1px solid rgba(255,255,255,0.06);margin-top:0.25rem;"></div>
                <!-- Tweet Feed -->
                <div class="x-tweet-feed" id="dt-tweet-feed"></div>
            </div>

            <!-- Sorare Widget -->
            <div class="card card-sorare">
                <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:0.5rem;">
                    <div style="display:flex;align-items:center;gap:0.5rem;font-size:0.85rem;font-weight:600;">
                        <img src="https://sorare.com/favicon.ico" alt="Sorare" style="width:18px;height:18px;border-radius:4px;filter:brightness(0) invert(1);">
                        Limited Champion
                        <span class="last-refresh" id="sorare-refresh">--</span>
                    </div>
                    <button class="refresh-btn" onclick="refreshSorare(this)">↻</button>
                </div>
                <div class="sorare-status-bar" id="sorare-status-bar">
                    <div>
                        <span class="sorare-gw" id="sorare-gw">GW--</span>
                        <span class="sorare-countdown" id="sorare-countdown">Loading...</span>
                    </div>
                    <span class="sorare-status-badge scheduled" id="sorare-status">--</span>
                </div>
                <div class="sorare-lineups" id="sorare-lineups">
                    <div class="sorare-lineup-card"><div style="text-align:center;color:var(--text-dim);font-size:0.7rem;">Loading lineups...</div></div>
                </div>
                <div class="sorare-summary">
                    <div class="sorare-summary-item"><div class="sorare-summary-value" id="sorare-limited-count">--</div><div class="sorare-summary-label">Limited Cards</div></div>
                    <div class="sorare-summary-item"><div class="sorare-summary-value" id="sorare-last-best">--</div><div class="sorare-summary-label">Last Best</div></div>
                    <div class="sorare-summary-item"><div class="sorare-summary-value" id="sorare-field-size">--</div><div class="sorare-summary-label">Field Size</div></div>
                </div>
            </div>
        </div>
    </main>

    <!-- Night Mode Overlay -->
    <div id="night-mode-overlay" class="night-mode-overlay" onclick="exitNightMode()">
        <div class="eink-time" id="eink-time">12:00</div>
        <div class="eink-ampm" id="eink-ampm">AM</div>
        <div class="eink-date" id="eink-date">—</div>
        <div class="eink-hint">tap anywhere to exit</div>
        <div class="bouncing-logo" id="bouncing-logo"><img src="icon-192.png" alt="Jane"></div>
    </div>

    <script src="dashboard-common.js"></script>
    <script>
        // Global error handler
        window.onerror = function(msg, url, line) { console.warn('Dashboard error:', msg, 'at line', line); return true; };
        window.addEventListener('unhandledrejection', function(e) { console.warn('Unhandled rejection:', e.reason?.message || e.reason); e.preventDefault(); });

        initAnimationPauseOnHidden();

        // Update time
        function updateTime() {
            const now = new Date();
            document.getElementById('current-time').textContent = now.toLocaleTimeString('en-US', { hour:'2-digit', minute:'2-digit', hour12:true });
            document.getElementById('current-date').textContent = now.toLocaleDateString('en-US', { weekday:'long', month:'short', day:'numeric' });
        }
        setInterval(updateTime, 1000);
        updateTime();

        // spinButton defined in dashboard-common.js

        // ===== SYSTEM STATUS =====
        let _cachedSessions = null;
        async function refreshSystem() {
            try {
                const [sessions, system] = await Promise.all([
                    fetchWithTimeout('/api/sessions', 10000),
                    fetchWithTimeout('/api/system', 10000)
                ]);
                _cachedSessions = sessions;
                if (sessions?.sessions?.length) {
                    const main = sessions.sessions.find(s => s.kind === 'main' || s.key === 'agent:main:main') || sessions.sessions[0];
                    if (main) {
                        const used = main.totalTokens || main.tokens || 0;
                        const cap = main.contextTokens || 200000;
                        const pct = Math.round((used / cap) * 100);
                        const ctxEl = document.getElementById('ctx-slim');
                        if (ctxEl) {
                            const prevPct = window._lastCtxPct || pct;
                            // Detect significant drop (compaction) — at least 10% decrease
                            if (prevPct - pct >= 10) {
                                flashCtxCompaction(ctxEl, prevPct, pct);
                            } else {
                                ctxEl.textContent = 'Ctx: ' + pct + '%';
                            }
                            ctxEl.className = 'status-slim-pill ' + (pct > 80 ? 'red' : pct > 60 ? '' : 'green');
                            window._lastCtxPct = pct;
                        }
                    }
                }
                if (system) {
                    document.getElementById('cpu-slim').textContent = 'CPU: ' + (system.cpu||0) + '%';
                    const m1Ram = system.memory||0;
                    const m2Ram = system.mini2 ? (system.mini2.memory||0) : m1Ram;
                    document.getElementById('ram-slim').textContent = 'RAM: ' + Math.round((m1Ram+m2Ram)/2) + '%';
                    // Age in days since creation (Jan 31, 2026)
                    const born = new Date('2026-01-31T00:00:00-05:00');
                    const ageDays = Math.floor((Date.now() - born.getTime()) / 86400000);
                    document.getElementById('jane-age-slim').textContent = 'Age: ' + ageDays + 'd';
                    // Mini1 health (we're running on it, so if system responded, it's up)
                    const m1 = document.getElementById('mini1-slim');
                    if (m1) { m1.textContent = 'Mini1: ✓'; m1.className = 'status-slim-pill green'; }
                    const m2 = document.getElementById('mini2-slim');
                    if (m2 && system.mini2) {
                        m2.textContent = 'Mini2: ' + (system.mini2.online ? '✓' : '✗');
                        m2.className = 'status-slim-pill ' + (system.mini2.online ? 'green' : 'red');
                    }
                }
            } catch(e) { console.error('System:', e); }
        }

        // ===== SUB-AGENT LOBSTERS ORBITING BRAIN =====
        const SA_COLORS = ['#06b6d4','#f97316','#a855f7','#ec4899','#84cc16','#eab308','#ef4444','#14b8a6'];
        const SA_LOBSTER_PATH = 'M60 10C30 10 15 35 15 55C15 75 30 95 45 100L45 110 55 110 55 100C55 100 60 102 65 100L65 110 75 110 75 100C90 95 105 75 105 55C105 35 90 10 60 10Z M20 45C5 40 0 50 5 60C10 70 20 65 25 55C28 48 25 45 20 45Z M100 45C115 40 120 50 115 60C110 70 100 65 95 55C92 48 95 45 100 45Z';
        const SA_ANTENNA = '<path d="M45 15Q35 5 30 8" stroke="currentColor" stroke-width="3" stroke-linecap="round"/><path d="M75 15Q85 5 90 8" stroke="currentColor" stroke-width="3" stroke-linecap="round"/>';
        const SA_EYES = '<circle cx="45" cy="35" r="6" fill="#050810"/><circle cx="75" cy="35" r="6" fill="#050810"/><circle cx="46" cy="34" r="2.5" fill="#00e5cc"/><circle cx="76" cy="34" r="2.5" fill="#00e5cc"/>';
        let _prevSaIds = new Set();
        function updateSubagentSatellites(subAgents) {
            const orbit = document.getElementById('sa-orbit');
            if (!orbit) return;
            const normalized = (subAgents||[]).map(s => typeof s === 'string' ? {label: s, status: 'active'} : s);
            const active = normalized.filter(s => s.status === 'active' || s.status === 'running');
            const activeIds = new Set(active.map(s => s.id || s.label));
            // fade out removed
            orbit.querySelectorAll('.sa-lobster').forEach(el => {
                if (!activeIds.has(el.dataset.saId)) { el.classList.add('fade-out'); setTimeout(() => el.remove(), 1000); }
            });
            if (!active.length) { _prevSaIds = activeIds; return; }
            const rect = orbit.getBoundingClientRect();
            const cx = rect.width / 2, cy = rect.height / 2;
            const radius = Math.min(cx, cy) * 0.75;
            active.forEach((s, i) => {
                const id = s.id || s.label || 'sa-'+i;
                const color = SA_COLORS[i % SA_COLORS.length];
                const angle = (2 * Math.PI * i / active.length) - Math.PI/2;
                const x = cx + radius * Math.cos(angle) - 11;
                const y = cy + radius * Math.sin(angle) - 11;
                let el = orbit.querySelector(`[data-sa-id="${id}"]`);
                if (!el) {
                    el = document.createElement('div');
                    el.className = 'sa-lobster';
                    el.dataset.saId = id;
                    const lbl = s.label || s.id || 'sub-agent';
                    el.innerHTML = `<svg viewBox="0 0 120 120" xmlns="http://www.w3.org/2000/svg"><path d="${SA_LOBSTER_PATH}" fill="${color}"/>${SA_ANTENNA.replace(/currentColor/g, color)}${SA_EYES}</svg><div class="sa-lobster-label" style="color:${color}">${lbl}</div>`;
                    orbit.appendChild(el);
                }
                const delay = (i * 0.5) % 3;
                el.style.cssText = `left:${x}px;top:${y}px;animation:saFloat 3s ${delay}s ease-in-out infinite;filter:drop-shadow(0 0 6px ${color});`;
                el.classList.remove('fade-out');
            });
            _prevSaIds = activeIds;
        }

        // ===== X STATS =====
        async function refreshXStats(btn) {
            const doRefresh = async () => {
                try {
                    const data = await fetchWithTimeout('/x-stats.json', 5000);
                    if (!data) return;
                    const fmt = v => v >= 1000 ? (v/1000).toFixed(1)+'K' : String(v);
                    const set = (id, val) => { const el = document.querySelector('#'+id+' .x-strip-val'); if(el) el.textContent = val; };
                    set('x-engagement', data.engagementRate || '--');
                    set('x-followers', fmt(data.followers||0));
                    set('x-impressions', fmt(data.impressions||0));
                    set('x-likes', fmt(data.likes||0));
                    const base = data.prev24h || {};
                    const showDelta = (id, current, previous) => {
                        const el = document.getElementById(id);
                        if (!el || previous == null) { if(el) el.textContent=''; return; }
                        const diff = current - previous;
                        if (diff > 0) { el.textContent = '+'+fmt(diff); el.className='x-strip-delta up'; }
                        else if (diff < 0) { el.textContent = fmt(diff); el.className='x-strip-delta down'; }
                        else { el.textContent = '—'; el.className='x-strip-delta flat'; }
                    };
                    showDelta('x-d-followers', data.followers, base.followers);
                    showDelta('x-d-impressions', data.impressions, base.impressions);
                    showDelta('x-d-likes', data.likes, base.likes);
                    // Engagement delta
                    const engEl = document.getElementById('x-engagement');
                    if (engEl && base.engagementRate) {
                        const curEng = parseFloat(data.engagementRate) || 0;
                        const baseEng = parseFloat(base.engagementRate) || 0;
                        const engDiff = (curEng - baseEng).toFixed(1);
                        let deltaSpan = engEl.querySelector('.x-strip-delta');
                        if (!deltaSpan) { deltaSpan = document.createElement('span'); deltaSpan.className = 'x-strip-delta'; engEl.appendChild(deltaSpan); }
                        if (engDiff > 0) { deltaSpan.textContent = '+'+engDiff+'%'; deltaSpan.className = 'x-strip-delta up'; }
                        else if (engDiff < 0) { deltaSpan.textContent = engDiff+'%'; deltaSpan.className = 'x-strip-delta down'; }
                        else { deltaSpan.textContent = '—'; deltaSpan.className = 'x-strip-delta flat'; }
                    }
                    // Content plan indicator — remaining today
                    try {
                        const plan = await fetchWithTimeout('/x-content-plan.json', 5000);
                        if (plan) {
                            let threads = {}, replies = {};
                            if (plan.plan) { threads = plan.plan.threads || {}; replies = plan.plan.replies || {}; }
                            else if (plan.rolling24h) { threads = plan.rolling24h.originalTweets || {}; replies = plan.rolling24h.replies || {}; }
                            const cpEl = document.getElementById('x-content-plan');
                            if (cpEl) {
                                const tRemain = (threads.planned||0) - (threads.completed||0);
                                const rRemain = (replies.planned||0) - (replies.completed||0);
                                // Next up item
                                let nextUp = '';
                                const details = [...(threads.details||[]), ...(replies.details||[])].filter(d => d.status === 'pending').sort((a,b) => a.time.replace('~','').localeCompare(b.time.replace('~','')));
                                if (details.length) nextUp = details[0].time + ' ' + details[0].name;
                                const pipeSvg = '<svg width="1" height="12" style="opacity:0.15"><line x1="0" y1="0" x2="0" y2="12" stroke="white" stroke-width="1"/></svg>';
                                cpEl.innerHTML =
                                    `<span style="display:flex;align-items:center;gap:4px;color:#1d9bf0;"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="#1d9bf0" stroke-width="2.5"><path d="M4 6h16M4 12h16M4 18h16"/></svg><span style="font-weight:600;">${tRemain}</span><span style="color:rgba(255,255,255,0.4);">threads</span></span>` +
                                    pipeSvg +
                                    `<span style="display:flex;align-items:center;gap:4px;color:#a78bfa;"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="#a78bfa" stroke-width="2.5"><path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/></svg><span style="font-weight:600;">${rRemain}</span><span style="color:rgba(255,255,255,0.4);">replies</span></span>` +
                                    (nextUp ? pipeSvg + `<span style="color:rgba(255,255,255,0.3);font-style:italic;">next: ${nextUp}</span>` : '');
                            }
                        }
                    } catch(e) {}
                    const el = document.getElementById('x-refresh');
                    if (el) el.textContent = new Date().toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit'});
                } catch(e) { console.error('X stats:', e); }
            };
            if (btn) return spinButton(btn, doRefresh());
            return doRefresh();
        }

        // ===== X TWEET FEED =====
        window._dtThreadData = [];
        window._dtThreadIdx = 0;

        async function refreshDesktopTweetFeed() {
            const [histData, latestData] = await Promise.all([
                fetchWithTimeout('/x-thread-history.json', 5000),
                fetchWithTimeout('/x-latest-tweets.json', 5000)
            ]);
            if (histData && histData.threads && histData.threads.length > 0) {
                window._dtThreadData = histData.threads;
            } else if (latestData && latestData.tweets) {
                window._dtThreadData = [{ date:'Latest', label:'Latest', tweets:latestData.tweets, lastUpdated:latestData.lastUpdated }];
            }
            dtRenderAllThreads();
        }

        function dtNeonEmoji(text) {
            const neonStyle = 'display:inline-block;color:#4ade80;text-shadow:0 0 6px #4ade80,0 0 12px #4ade8088;font-size:0.85em;vertical-align:middle;';
            const map = {
                '🌪️': `<svg style="${neonStyle}width:1em;height:1em;" viewBox="0 0 24 24" fill="none" stroke="#4ade80" stroke-width="2"><path d="M4 8h14c1 0 2-1 2-2s-1-2-2-2H6"/><path d="M3 12h18c1 0 2 1 2 2s-1 2-2 2H8"/><path d="M6 16h8c1 0 2 1 2 2s-1 2-2 2H10"/></svg>`,
                '🤖': `<svg style="${neonStyle}width:1em;height:1em;" viewBox="0 0 24 24" fill="none" stroke="#4ade80" stroke-width="2"><rect x="4" y="6" width="16" height="14" rx="3"/><circle cx="9" cy="13" r="1.5" fill="#4ade80"/><circle cx="15" cy="13" r="1.5" fill="#4ade80"/><line x1="12" y1="2" x2="12" y2="6"/><circle cx="12" cy="2" r="1" fill="#4ade80"/></svg>`,
                '💼': `<svg style="${neonStyle}width:1em;height:1em;" viewBox="0 0 24 24" fill="none" stroke="#4ade80" stroke-width="2"><rect x="2" y="7" width="20" height="13" rx="2"/><path d="M16 7V5a2 2 0 00-2-2h-4a2 2 0 00-2 2v2"/></svg>`,
                '📈': `<svg style="${neonStyle}width:1em;height:1em;" viewBox="0 0 24 24" fill="none" stroke="#4ade80" stroke-width="2"><polyline points="22 7 13.5 15.5 8.5 10.5 2 17"/><polyline points="16 7 22 7 22 13"/></svg>`,
                '📊': `<svg style="${neonStyle}width:1em;height:1em;" viewBox="0 0 24 24" fill="none" stroke="#4ade80" stroke-width="2"><rect x="4" y="12" width="4" height="8"/><rect x="10" y="6" width="4" height="14"/><rect x="16" y="9" width="4" height="11"/></svg>`,
                '🔥': `<svg style="${neonStyle}width:1em;height:1em;" viewBox="0 0 24 24" fill="none" stroke="#f59e0b" stroke-width="2" style="filter:drop-shadow(0 0 4px #f59e0b)"><path d="M12 22c4-3 7-6 7-10a7 7 0 00-14 0c0 4 3 7 7 10z"/><path d="M12 22c-2-2-3-4-3-6a3 3 0 016 0c0 2-1 4-3 6z" fill="#f59e0b" opacity="0.3"/></svg>`,
                '📰': `<svg style="${neonStyle}width:1em;height:1em;" viewBox="0 0 24 24" fill="none" stroke="#4ade80" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="7" y1="8" x2="17" y2="8"/><line x1="7" y1="12" x2="13" y2="12"/><line x1="7" y1="16" x2="15" y2="16"/></svg>`,
                '🔄': `<svg style="${neonStyle}width:1em;height:1em;" viewBox="0 0 24 24" fill="none" stroke="#4ade80" stroke-width="2"><polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0114.85-3.36L23 10"/><path d="M20.49 15a9 9 0 01-14.85 3.36L1 14"/></svg>`,
                '📌': `<svg style="${neonStyle}width:1em;height:1em;" viewBox="0 0 24 24" fill="none" stroke="#4ade80" stroke-width="2"><path d="M9 3l7 7-4 1 3 6-1 1-6-3-1 4-7-7 1-1 6 3 1-4z"/><line x1="5" y1="19" x2="9" y2="15"/></svg>`
            };
            let result = text;
            for (const [emoji, svg] of Object.entries(map)) {
                result = result.split(emoji).join(svg);
            }
            return result;
        }

        function dtRenderAllThreads() {
            const threads = window._dtThreadData;
            const container = document.getElementById('dt-tweet-feed');
            if (!threads || !threads.length || !container) return;
            container.innerHTML = '';

            // Determine today's date string for pinning logic
            const now = new Date();
            const todayStr = now.toLocaleDateString('en-US', { weekday:'short', month:'short', day:'numeric' });

            // Render all threads chronologically (newest first — already sorted)
            threads.forEach((thread, tIdx) => {
                // Thread date header
                const header = document.createElement('div');
                header.style.cssText = 'font-size:0.7rem;font-weight:600;color:#4ade80;padding:0.4rem 0 0.2rem;' + (tIdx > 0 ? 'border-top:1px solid rgba(255,255,255,0.06);margin-top:0.5rem;padding-top:0.6rem;' : '');
                header.innerHTML = (thread.label || thread.date || '');
                container.appendChild(header);
                (thread.tweets || []).forEach((rawTweet, i) => {
                    const tweet = typeof rawTweet === 'string' ? { text: rawTweet } : rawTweet;
                    const div = document.createElement('div');
                    div.className = 'x-tweet-item';
                    if (i === 0) div.style.borderLeftColor = '#4ade80';
                    let timeDisplay = '';
                    const rawTime = tweet.timestamp || tweet.time || '';
                    if (rawTime) {
                        const t = new Date(rawTime);
                        if (!isNaN(t.getTime()) && rawTime.includes('T')) {
                            // ISO timestamp — format as relative or readable
                            const mins = Math.round((Date.now()-t.getTime())/60000);
                            if (mins<1) timeDisplay='just now';
                            else if (mins<60) timeDisplay=mins+'m ago';
                            else if (mins<1440) timeDisplay=Math.round(mins/60)+'h ago';
                            else timeDisplay=t.toLocaleDateString([],{month:'short',day:'numeric'})+' '+t.toLocaleTimeString([],{hour:'numeric',minute:'2-digit'});
                        } else {
                            // Already human-readable like "8:30 AM"
                            timeDisplay = rawTime;
                        }
                    }
                    const threadNum = tweet.threadNum ? '<span style="color:#4ade80;font-weight:600;font-size:0.65rem;margin-right:4px;">'+tweet.threadNum+'</span>' : '';
                    const imageUrl = tweet.image || tweet.imageUrl || null;
                    const imageHtml = imageUrl ? '<img src="'+imageUrl+'" style="max-width:30%;border-radius:4px;margin-top:4px;opacity:0.8;border:1px solid rgba(74,222,128,0.12);">' : '';
                    div.innerHTML = '<div class="x-tweet-meta">'+
                        '<div>'+threadNum+'<span class="x-tweet-stat">'+timeDisplay+'</span></div>'+
                        '<div style="display:flex;gap:0.5rem;">'+
                        (tweet.views?'<span class="x-tweet-stat"><svg style="display:inline-block;vertical-align:middle;width:12px;height:12px;margin-right:2px;" viewBox="0 0 24 24" fill="none" stroke="#4ade80" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg> '+tweet.views+'</span>':'')+
                        (tweet.likes?'<span class="x-tweet-stat"><svg style="display:inline-block;vertical-align:middle;width:12px;height:12px;margin-right:2px;" viewBox="0 0 24 24" fill="none" stroke="#f97316" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 00-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 00-7.78 7.78L12 21.23l8.84-8.84a5.5 5.5 0 000-7.78z"/></svg> '+tweet.likes+'</span>':'')+
                        (tweet.reposts?'<span class="x-tweet-stat"><svg style="display:inline-block;vertical-align:middle;width:12px;height:12px;margin-right:2px;" viewBox="0 0 24 24" fill="none" stroke="#4ade80" stroke-width="2"><polyline points="17 1 21 5 17 9"/><path d="M3 11V9a4 4 0 014-4h14"/><polyline points="7 23 3 19 7 15"/><path d="M21 13v2a4 4 0 01-4 4H3"/></svg> '+tweet.reposts+'</span>':'')+
                        '</div></div>'+
                        '<div class="x-tweet-text">'+dtNeonEmoji(tweet.text||'')+'</div>'+
                        imageHtml;
                    container.appendChild(div);
                });
            });
        }

        // ===== CONNECTIONS =====
        async function refreshConnections(btn) {
            const doRefresh = async () => {
                try {
                    const data = await fetchWithTimeout('/api/connections', 5000);
                    if (!data) return;
                    const sortA = arr => [...arr].sort((a,b) => a.name.localeCompare(b.name));
                    const render = (items, id) => {
                        const el = document.getElementById(id);
                        el.innerHTML = items.map(i => `
                            <div class="conn-item">
                                <img src="${i.icon}" alt="" class="${i.invert?'logo-invert':''}" onerror="this.style.display='none'">
                                <span title="${i.detail||''}">${i.name}</span>
                                ${i.active?'<span class="conn-dot"></span>':''}
                            </div>
                        `).join('');
                    };
                    render(sortA(data.accounts||[]), 'conn-accounts');
                    render(sortA(data.dataSources||[]), 'conn-datasources');
                    if (data.newsletters && data.newsletters.length) {
                        document.getElementById('conn-newsletters-section').style.display = '';
                        document.getElementById('conn-newsletters').innerHTML = sortA(data.newsletters).map(i => `
                            <div class="conn-item"><span style="font-size:0.7rem;"><svg style="display:inline-block;vertical-align:middle;width:12px;height:12px;" viewBox="0 0 24 24" fill="none" stroke="#06b6d4" stroke-width="2"><rect x="2" y="4" width="20" height="16" rx="2"/><polyline points="22 4 12 13 2 4"/></svg></span><span>${i.name}</span>${i.active?'<span class="conn-dot"></span>':''}</div>
                        `).join('');
                    }
                    if (data.podcasts && data.podcasts.length) {
                        document.getElementById('conn-podcasts-section').style.display = '';
                        document.getElementById('conn-podcasts').innerHTML = sortA(data.podcasts).map(i => `
                            <div class="conn-item"><span style="font-size:0.7rem;"><svg style="display:inline-block;vertical-align:middle;width:12px;height:12px;" viewBox="0 0 24 24" fill="none" stroke="#a855f7" stroke-width="2"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/></svg></span><span>${i.name}</span>${i.active?'<span class="conn-dot"></span>':''}</div>
                        `).join('');
                    }
                    document.getElementById('connections-refresh').textContent = new Date().toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit'});
                } catch(e) { console.error('Connections:', e); }
            };
            if (btn) return spinButton(btn, doRefresh());
            return doRefresh();
        }

        // ===== TODAY'S JOBS =====
        const jobsGroupColors = {'🌅 Morning':'#f59e0b','☀️ Midday':'#3b82f6','🌙 Evening':'#8b5cf6','🔄 Recurring':'#6b7280'};
        const jobsIconMap = {
            '🌅 Morning': '<svg style="display:inline-block;vertical-align:middle;width:12px;height:12px;margin-right:3px;" viewBox="0 0 24 24" fill="none" stroke="#f59e0b" stroke-width="2"><path d="M17 18a5 5 0 00-10 0"/><line x1="12" y1="9" x2="12" y2="2"/><line x1="4.22" y1="10.22" x2="5.64" y2="11.64"/><line x1="1" y1="18" x2="3" y2="18"/><line x1="21" y1="18" x2="23" y2="18"/><line x1="18.36" y1="11.64" x2="19.78" y2="10.22"/><line x1="23" y1="22" x2="1" y2="22"/></svg>',
            '☀️ Midday': '<svg style="display:inline-block;vertical-align:middle;width:12px;height:12px;margin-right:3px;" viewBox="0 0 24 24" fill="none" stroke="#3b82f6" stroke-width="2"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>',
            '🌙 Evening': '<svg style="display:inline-block;vertical-align:middle;width:12px;height:12px;margin-right:3px;" viewBox="0 0 24 24" fill="none" stroke="#8b5cf6" stroke-width="2"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>',
            '🔄 Recurring': '<svg style="display:inline-block;vertical-align:middle;width:12px;height:12px;margin-right:3px;" viewBox="0 0 24 24" fill="none" stroke="#6b7280" stroke-width="2"><polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0114.85-3.36L23 10"/><path d="M20.49 15a9 9 0 01-14.85 3.36L1 14"/></svg>'
        };
        function renderJobs(data) {
            if (!data || !data.groups) return;
            let total=0, done=0;
            const allJobs = [];
            data.groups.forEach(g => g.jobs.forEach(j => { if(g.label !== '🔄 Recurring') { total++; if(j.done === true || j.done === 'missed') done++; } allJobs.push({...j, group:g.label}); }));
            document.getElementById('jobs-count').textContent = `${done}/${total}`;
            // find next upcoming
            const now = new Date();
            let nextJob = null;
            for (const g of data.groups) {
                if (g.label === '🔄 Recurring') continue;
                for (const j of g.jobs) {
                    if (!j.done && j.done !== 'missed') { nextJob = j; break; }
                }
                if (nextJob) break;
            }
            let html = '';
            data.groups.forEach(g => {
                const color = jobsGroupColors[g.label] || '#888';
                const svgIcon = jobsIconMap[g.label] || '';
                const cleanLabel = g.label.replace(/^[\u{1F300}-\u{1FAFF}\u{2600}-\u{27BF}\u{FE0F}\s]+/u, '');
                html += `<div style="margin-top:0.4rem;margin-bottom:0.2rem;font-size:10px;font-weight:700;color:${color};letter-spacing:0.03em;">${svgIcon}${cleanLabel}</div>`;
                g.jobs.forEach(j => {
                    const isNext = j === nextJob;
                    const isMissed = j.done === 'missed';
                    const isDone = j.done === true;
                    const dim = (isDone || isMissed) ? 'opacity:0.45;' : '';
                    const strike = (isDone || isMissed) ? 'text-decoration:line-through;' : '';
                    const border = isNext ? 'border-left:2px solid #4ade80;padding-left:6px;' : 'padding-left:8px;';
                    const badge = isNext ? '<span style="background:#4ade80;color:#000;font-size:9px;font-weight:800;padding:1px 4px;border-radius:3px;margin-left:6px;">NEXT</span>' : '';
                    const status = isDone ? ' <svg style="display:inline-block;vertical-align:middle;width:11px;height:11px;" viewBox="0 0 24 24" fill="none" stroke="#4ade80" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>'
                        : isMissed ? ' <span style="color:#ef4444;font-size:9px;font-weight:700;margin-left:4px;">MISSED</span>'
                        : '';
                    const timeStr = j.nextRun ? `<span style="color:rgba(255,255,255,0.35);font-size:10px;margin-left:6px;">next: ${j.nextRun}</span>` : `<span style="color:rgba(255,255,255,0.3);font-size:10px;margin-left:6px;">${j.time}</span>`;
                    html += `<div style="display:flex;align-items:center;${dim}${border}margin:2px 0;"><span style="font-size:11px;color:rgba(255,255,255,0.85);${strike}">${j.name}${status}</span>${badge}${timeStr}</div>`;
                });
            });
            document.getElementById('jobs-body').innerHTML = html;
        }
        async function fetchJobs() {
            try {
                const data = await fetchWithTimeout('/cron-schedule.json', 5000);
                renderJobs(data);
            } catch(e) { console.error('Jobs fetch:', e); }
        }
        fetchJobs();
        setInterval(fetchJobs, 60000);
        document.getElementById('jobs-toggle').addEventListener('click', () => {
            openPopup('jobs');
        });
        // WebSocket cron-schedule updates handled via batch handler in main WS setup

        // Connected Accounts toggle
        document.getElementById('conn-toggle').addEventListener('click', () => {
            openPopup('conn');
        });

        // ===== SORARE =====
        async function refreshSorare(btn) {
            const doRefresh = async () => {
                try {
                    const data = await fetchWithTimeout('/api/sorare', 10000);
                    document.getElementById('sorare-limited-count').textContent = data.limitedCards || 0;
                    const current = data.currentFixture || {};
                    const leaderboard = current.leaderboard || {};
                    document.getElementById('sorare-gw').textContent = current.gameWeek ? 'GW'+current.gameWeek : 'GW--';
                    document.getElementById('sorare-field-size').textContent = leaderboard.totalLineups?.toLocaleString() || '--';
                    const now = new Date();
                    const start = current.startDate ? new Date(current.startDate) : null;
                    const end = current.endDate ? new Date(current.endDate) : null;
                    let status = 'scheduled', countdown = '';
                    if (start && end) {
                        if (now < start) { const d=start-now; countdown=`Starts in ${Math.floor(d/3600000)}h ${Math.floor((d%3600000)/60000)}m`; status='scheduled'; }
                        else if (now < end) { const d=end-now; const h=Math.floor(d/3600000); countdown=`${h}h ${Math.floor((d%3600000)/60000)}m left`; status=h<6?'ending':'live'; }
                        else { countdown='Completed'; status='final'; }
                    }
                    document.getElementById('sorare-countdown').textContent = countdown;
                    document.getElementById('sorare-countdown').className = 'sorare-countdown '+status;
                    const statusEl = document.getElementById('sorare-status');
                    statusEl.textContent = status.toUpperCase();
                    statusEl.className = 'sorare-status-badge '+status;
                    const lineupsEl = document.getElementById('sorare-lineups');
                    const lineups = leaderboard.myLineups || [];
                    if (lineups.length > 0) {
                        lineupsEl.innerHTML = lineups.map(l => {
                            const players = l.players||[];
                            const isLive = players.some(p=>p.status==='playing');
                            return `<div class="sorare-lineup-card${isLive?' live':''}">
                                <div class="sorare-lineup-header">
                                    <span class="sorare-lineup-num">Lineup ${l.number}</span>
                                    <span class="sorare-lineup-rank">${l.ranking?'#'+l.ranking:'--'}</span>
                                    <span class="sorare-lineup-score">${l.score>0?l.score.toFixed(1)+' pts':'Scheduled'}</span>
                                </div>
                                <div class="sorare-lineup-players">${players.map(p=>{
                                    const last=p.name?.split(' ').pop()||'?';
                                    const cls=p.status==='playing'?'sorare-player playing':p.status==='final'?'sorare-player final':'sorare-player';
                                    return `<span class="${cls}">${last}${p.score>0?' ('+p.score.toFixed(0)+')':''}</span>`;
                                }).join('')}</div>
                            </div>`;
                        }).join('');
                    } else {
                        lineupsEl.innerHTML = '<div class="sorare-lineup-card"><div style="text-align:center;color:var(--text-dim);font-size:0.7rem;">No lineups registered</div></div>';
                    }
                    const completed = data.completedFixture || {};
                    document.getElementById('sorare-last-best').textContent = completed.bestRank ? '#'+completed.bestRank : '--';
                    document.getElementById('sorare-refresh').textContent = new Date().toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit'});
                } catch(e) { console.error('Sorare:', e); }
            };
            if (btn) return spinButton(btn, doRefresh());
            return doRefresh();
        }

        // ===== JANE'S MIND =====
        let mindState = { task: null, steps: [], thought: 'Ready for your next request.' };

        var brainRegions = [
            { name:'Reasoning', dx:0, dy:-130 },
            { name:'Coding', dx:55, dy:-70 },
            { name:'Research', dx:80, dy:0 },
            { name:'Communication', dx:55, dy:70 },
            { name:'Content', dx:0, dy:130 },
            { name:'Markets', dx:-55, dy:70 },
            { name:'Browsing', dx:-80, dy:0 },
            { name:'Memory', dx:-55, dy:-70 }
        ];
        var brainToolColors = {
            'opus':'#4ade80','claude':'#4ade80','sonnet':'#a78bfa',
            'whisper':'#facc15','tts':'#facc15',
            'browser':'#3b82f6','web_search':'#3b82f6','web_fetch':'#3b82f6',
            'ollama':'#f97316',
            'grok':'#ef4444',
            'qwen':'#06b6d4',
            'phi':'#ec4899',
            'qwen':'#ec4899',
            'x':'#1d9bf0','twitter':'#1d9bf0',
            'sorare':'#ffd700',
            'dexscreener':'#a855f7','trading':'#a855f7','memecoins':'#a855f7','kalshi':'#a855f7',
            'gmail':'#ef4444','email':'#ef4444',
            'whatsapp':'#25d366','message':'#25d366',
            'finnhub':'#06b6d4','coingecko':'#06b6d4','ticker':'#06b6d4',
            'stable-diffusion':'#ec4899','sd':'#ec4899','image':'#ec4899',
            'default':'rgba(74,222,128,0.3)'
        };
        var brainToolToRegions = {
            'opus':['Reasoning'],'claude':['Reasoning'],'sonnet':['Reasoning'],
            'ollama':['Coding','Reasoning'],'qwen':['Coding'],
            'grok':['Research','Browsing'],
            'qwen':['Coding','Reasoning'],
            'phi':['Research','Reasoning'],
            'whisper':['Communication'],'tts':['Communication'],
            'web_search':['Research'],'web_fetch':['Research'],'browser':['Browsing'],
            'exec':['Coding'],'read':['Memory'],'write':['Memory'],'edit':['Memory','Coding'],
            'message':['Communication'],'sessions_spawn':['Reasoning'],'sessions_send':['Communication'],
            'trading':['Markets'],'kalshi':['Markets'],'memecoins':['Markets'],
            'sorare':['Markets'],
            'x':['Content'],'twitter':['Content'],
            'gmail':['Communication'],'email':['Communication'],
            'finnhub':['Markets'],'coingecko':['Markets'],'ticker':['Markets'],
            'stable-diffusion':['Content'],'sd':['Content'],'image':['Content'],
            'cron':['Reasoning'],'session_status':['Reasoning'],'sessions_list':['Reasoning'],
            'memory_search':['Memory'],'memory_get':['Memory'],
            'whatsapp':['Communication']
        };
        var activeRegions = new Set();

        function initBrainMap() {
            const cx=100, cy=190;
            const linesG = document.getElementById('brain-lines');
            const nodesG = document.getElementById('brain-nodes');
            linesG.innerHTML=''; nodesG.innerHTML='';
            brainRegions.forEach((region,i) => {
                const x=cx+region.dx, y=cy+region.dy;
                region.x=x; region.y=y;
                // Compute line from hub edge to node edge
                const hubR=18, nodeR=2.8;
                const dist = Math.sqrt(region.dx*region.dx + region.dy*region.dy);
                const ux=region.dx/dist, uy=region.dy/dist;
                const lx1=cx+ux*hubR, ly1=cy+uy*hubR;
                const lx2=x-ux*nodeR, ly2=y-uy*nodeR;
                const line = document.createElementNS('http://www.w3.org/2000/svg','line');
                line.setAttribute('x1',lx1); line.setAttribute('y1',ly1);
                line.setAttribute('x2',lx2); line.setAttribute('y2',ly2);
                line.setAttribute('stroke','rgba(74,222,128,0.1)'); line.setAttribute('stroke-width','0.6');
                line.setAttribute('stroke-dasharray','2 3'); line.setAttribute('id','brain-line-'+i);
                line.classList.add('brain-line');
                linesG.appendChild(line);
                const tick = document.createElementNS('http://www.w3.org/2000/svg','line');
                const angle = Math.atan2(region.dy,region.dx);
                const px=Math.cos(angle+Math.PI/2)*5, py=Math.sin(angle+Math.PI/2)*5;
                tick.setAttribute('x1',x-px); tick.setAttribute('y1',y-py);
                tick.setAttribute('x2',x+px); tick.setAttribute('y2',y+py);
                tick.setAttribute('stroke','rgba(74,222,128,0.15)'); tick.setAttribute('stroke-width','0.6');
                linesG.appendChild(tick);
                const circle = document.createElementNS('http://www.w3.org/2000/svg','circle');
                circle.setAttribute('cx',x); circle.setAttribute('cy',y); circle.setAttribute('r','2.8');
                circle.setAttribute('fill','rgba(74,222,128,0.35)'); circle.setAttribute('stroke','rgba(74,222,128,0.2)');
                circle.setAttribute('stroke-width','0.6'); circle.setAttribute('id','brain-node-'+i);
                circle.classList.add('brain-node-circle');
                nodesG.appendChild(circle);
                const label = document.createElementNS('http://www.w3.org/2000/svg','text');
                // Position label outside the shape based on node direction
                let lx=x, ly=y, anchor='middle';
                if (Math.abs(region.dx) > Math.abs(region.dy)) {
                    // Primarily left/right
                    ly = y + 3; // vertically center
                    if (region.dx > 0) { lx = x + 8; anchor = 'start'; }
                    else { lx = x - 8; anchor = 'end'; }
                } else {
                    // Primarily top/bottom
                    if (region.dy < 0) { ly = y - 10; }
                    else { ly = y + 14; }
                }
                label.setAttribute('x', lx); label.setAttribute('y', ly);
                label.setAttribute('text-anchor', anchor);
                label.textContent = region.name;
                label.classList.add('brain-node-label'); label.setAttribute('id','brain-label-'+i);
                nodesG.appendChild(label);
            });
            
            // Initialize radar ticks (12 tick marks around outer ring)
            const radarTicksG = document.getElementById('radar-ticks');
            radarTicksG.innerHTML = '';
            for (let i = 0; i < 12; i++) {
                const angle = (i * 30 - 90) * Math.PI / 180; // Start from top
                const r1 = 28, r2 = 32;
                const x1 = cx + Math.cos(angle) * r1;
                const y1 = cy + Math.sin(angle) * r1;
                const x2 = cx + Math.cos(angle) * r2;
                const y2 = cy + Math.sin(angle) * r2;
                const tick = document.createElementNS('http://www.w3.org/2000/svg','line');
                tick.setAttribute('x1',x1); tick.setAttribute('y1',y1);
                tick.setAttribute('x2',x2); tick.setAttribute('y2',y2);
                tick.classList.add('radar-tick');
                tick.style.animationDelay = (i * 0.15) + 's';
                radarTicksG.appendChild(tick);
            }
            
            // Initialize matrix rain
            initMatrixRain();
            
            // Start ambient particles
            startAmbientParticles();
        }
        
        // Matrix rain background effect
        function initMatrixRain() {
            const matrixG = document.getElementById('matrix-rain');
            if (!matrixG) return;
            const chars = '01アイウエオカキクケコサシスセソタチツテト';
            const columns = 15;
            for (let i = 0; i < columns; i++) {
                for (let j = 0; j < 8; j++) {
                    const char = chars[Math.floor(Math.random() * chars.length)];
                    const text = document.createElementNS('http://www.w3.org/2000/svg','text');
                    text.classList.add('matrix-char');
                    text.setAttribute('x', -5 + i * 14);
                    text.setAttribute('y', 30 + j * 45);
                    text.textContent = char;
                    const delay = Math.random() * 3;
                    text.style.animationDelay = delay + 's';
                    matrixG.appendChild(text);
                }
            }
        }
        
        // Ambient floating particles
        let _particleInterval = null;
        function startAmbientParticles() {
            if (_particleInterval) return;
            const particlesG = document.getElementById('brain-particles');
            if (!particlesG) return;
            
            function spawnParticle() {
                const angle = Math.random() * Math.PI * 2;
                const radius = 60 + Math.random() * 80;
                const cx = 100 + Math.cos(angle) * radius;
                const cy = 190 + Math.sin(angle) * radius;
                const particle = document.createElementNS('http://www.w3.org/2000/svg','circle');
                particle.setAttribute('cx', cx);
                particle.setAttribute('cy', cy);
                particle.setAttribute('r', 0.6 + Math.random() * 1);
                particle.setAttribute('fill', 'rgba(74,222,128,0.5)');
                particle.classList.add('brain-particle');
                const px = (Math.random() - 0.5) * 40;
                const py = (Math.random() - 0.5) * 40;
                particle.style.setProperty('--px', px + 'px');
                particle.style.setProperty('--py', py + 'px');
                particle.style.animation = 'particleFloat ' + (4 + Math.random() * 3) + 's ease-in-out forwards';
                particlesG.appendChild(particle);
                setTimeout(() => { try { particlesG.removeChild(particle); } catch(e){} }, 7000);
            }
            
            _particleInterval = setInterval(() => {
                const svg = document.getElementById('brain-map');
                if (svg && svg.classList.contains('brain-active')) {
                    for (let i = 0; i < 2; i++) spawnParticle();
                } else if (Math.random() > 0.6) {
                    spawnParticle();
                }
            }, 800);
        }
        
        // Track Ollama usage
        let _ollamaActive = false;
        function updateOllamaIndicator(isActive) {
            const svg = document.getElementById('brain-map');
            if (isActive && !_ollamaActive) {
                svg.classList.add('ollama-active');
                _ollamaActive = true;
            } else if (!isActive && _ollamaActive) {
                svg.classList.remove('ollama-active');
                _ollamaActive = false;
            }
        }

        let _grokActive = false;
        function updateGrokIndicator(isActive) {
            const svg = document.getElementById('brain-map');
            if (isActive && !_grokActive) {
                svg.classList.add('grok-active');
                _grokActive = true;
            } else if (!isActive && _grokActive) {
                svg.classList.remove('grok-active');
                _grokActive = false;
            }
        }

        function activateBrainRegion(regionName, color) {
            const idx = brainRegions.findIndex(r=>r.name===regionName);
            if (idx===-1) return;
            const node = document.getElementById('brain-node-'+idx);
            const line = document.getElementById('brain-line-'+idx);
            const label = document.getElementById('brain-label-'+idx);
            if (node) { 
                node.setAttribute('fill',color); 
                node.setAttribute('fill-opacity','0.85'); 
                node.setAttribute('filter','drop-shadow(0 0 8px '+color+') drop-shadow(0 0 16px '+color+')'); 
                node.setAttribute('r','5.5'); 
                // Spawn expanding activation ring
                spawnActivationRing(brainRegions[idx].x, brainRegions[idx].y, color);
            }
            if (line) { line.setAttribute('stroke',color); line.setAttribute('stroke-opacity','0.7'); line.setAttribute('stroke-width','1.2'); }
            if (label) { label.setAttribute('fill',color); label.setAttribute('font-size','7.5'); label.style.filter='drop-shadow(0 0 8px '+color+') drop-shadow(0 0 16px '+color+')'; }
            activeRegions.add(regionName);
            spawnPulseDot(idx, color);
        }
        
        // Expanding ring effect when node activates
        function spawnActivationRing(x, y, color) {
            const nodesG = document.getElementById('brain-nodes');
            if (!nodesG) return;
            const ring = document.createElementNS('http://www.w3.org/2000/svg','circle');
            ring.setAttribute('cx', x);
            ring.setAttribute('cy', y);
            ring.setAttribute('r', '4');
            ring.setAttribute('fill', 'none');
            ring.setAttribute('stroke', color);
            ring.setAttribute('stroke-width', '2');
            ring.setAttribute('opacity', '0.6');
            nodesG.appendChild(ring);
            let start = null;
            const duration = 600;
            (function animate(ts) {
                if (!start) start = ts;
                const t = Math.min((ts - start) / duration, 1);
                ring.setAttribute('r', String(4 + t * 14));
                ring.setAttribute('opacity', String(0.6 * (1 - t)));
                ring.setAttribute('stroke-width', String(2 * (1 - t)));
                if (t < 1) requestAnimationFrame(animate);
                else { try { nodesG.removeChild(ring); } catch(e){} }
            })(performance.now());
        }

        // Context % flash on compaction — animates the number counting down
        function flashCtxCompaction(el, fromPct, toPct) {
            el.style.transition = 'none';
            el.style.color = '#06b6d4';
            el.style.textShadow = '0 0 12px #06b6d4, 0 0 24px #06b6d4';
            el.style.transform = 'scale(1.3)';
            let start = null;
            const duration = 1200;
            (function animateCount(ts) {
                if (!start) start = ts;
                const t = Math.min((ts - start) / duration, 1);
                const current = Math.round(fromPct + (toPct - fromPct) * t);
                el.textContent = 'Ctx: ' + current + '%';
                if (t < 1) { requestAnimationFrame(animateCount); return; }
                // Flash 3 times then settle
                let flashes = 0;
                const flashInterval = setInterval(() => {
                    el.style.opacity = el.style.opacity === '0.3' ? '1' : '0.3';
                    flashes++;
                    if (flashes >= 6) {
                        clearInterval(flashInterval);
                        el.style.opacity = '1';
                        el.style.color = '';
                        el.style.textShadow = '';
                        el.style.transform = '';
                    }
                }, 150);
            })(performance.now());
        }

        // Context compaction: all nodes converge to hub, hub flashes, nodes re-expand
        let compactionRunning = false;
        function triggerCompactionAnimation() {
            if (compactionRunning) return;
            compactionRunning = true;
            const hub = document.getElementById('brain-hub');
            const brainSvg = document.getElementById('brain-map');
            const nodesG = document.getElementById('brain-nodes');
            if (!hub || !brainSvg || !nodesG) { compactionRunning = false; return; }
            
            // Phase 1: Light all nodes bright cyan
            const compactColor = '#06b6d4';
            brainRegions.forEach((r, i) => {
                const node = document.getElementById('brain-node-' + i);
                const line = document.getElementById('brain-line-' + i);
                const label = document.getElementById('brain-label-' + i);
                if (node) { node.setAttribute('fill', compactColor); node.setAttribute('r', '5.5'); node.setAttribute('filter', 'drop-shadow(0 0 12px ' + compactColor + ')'); }
                if (line) { line.setAttribute('stroke', compactColor); line.setAttribute('stroke-opacity', '0.8'); line.setAttribute('stroke-width', '1.5'); }
                if (label) { label.setAttribute('fill', compactColor); label.style.filter = 'drop-shadow(0 0 8px ' + compactColor + ')'; }
                spawnActivationRing(r.x, r.y, compactColor);
            });
            brainSvg.classList.remove('brain-idle'); brainSvg.classList.add('brain-active');
            
            // Phase 2: After 400ms, animate nodes shrinking toward hub center
            const hubCx = 100, hubCy = 190;
            const origPositions = brainRegions.map(r => ({ x: r.x, y: r.y }));
            setTimeout(() => {
                let start = null;
                const duration = 800;
                (function animateConverge(ts) {
                    if (!start) start = ts;
                    const t = Math.min((ts - start) / duration, 1);
                    const ease = t < 0.5 ? 2 * t * t : 1 - Math.pow(-2 * t + 2, 2) / 2; // easeInOutQuad
                    brainRegions.forEach((r, i) => {
                        const node = document.getElementById('brain-node-' + i);
                        const line = document.getElementById('brain-line-' + i);
                        if (node) {
                            const cx = origPositions[i].x + (hubCx - origPositions[i].x) * ease;
                            const cy = origPositions[i].y + (hubCy - origPositions[i].y) * ease;
                            node.setAttribute('cx', cx); node.setAttribute('cy', cy);
                            node.setAttribute('r', String(5.5 * (1 - ease * 0.7)));
                        }
                        if (line) {
                            line.setAttribute('x2', origPositions[i].x + (hubCx - origPositions[i].x) * ease);
                            line.setAttribute('y2', origPositions[i].y + (hubCy - origPositions[i].y) * ease);
                        }
                    });
                    if (t < 1) { requestAnimationFrame(animateConverge); return; }
                    
                    // Phase 3: Hub flash
                    hub.setAttribute('stroke', '#06b6d4'); hub.setAttribute('stroke-width', '4');
                    hub.setAttribute('filter', 'drop-shadow(0 0 20px #06b6d4) drop-shadow(0 0 40px #06b6d4)');
                    // Big pulse ring from hub
                    const ring = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                    ring.setAttribute('cx', hubCx); ring.setAttribute('cy', hubCy);
                    ring.setAttribute('r', '8'); ring.setAttribute('fill', 'none');
                    ring.setAttribute('stroke', '#06b6d4'); ring.setAttribute('stroke-width', '3'); ring.setAttribute('opacity', '0.8');
                    nodesG.appendChild(ring);
                    let rs = null;
                    (function animateRing(ts2) {
                        if (!rs) rs = ts2;
                        const t2 = Math.min((ts2 - rs) / 1000, 1);
                        ring.setAttribute('r', String(8 + t2 * 80));
                        ring.setAttribute('opacity', String(0.8 * (1 - t2)));
                        ring.setAttribute('stroke-width', String(3 * (1 - t2)));
                        if (t2 < 1) requestAnimationFrame(animateRing);
                        else { try { nodesG.removeChild(ring); } catch(e){} }
                    })(performance.now());
                    
                    // Phase 4: After 600ms, expand nodes back
                    setTimeout(() => {
                        let es = null;
                        const expandDur = 600;
                        (function animateExpand(ts3) {
                            if (!es) es = ts3;
                            const t3 = Math.min((ts3 - es) / expandDur, 1);
                            const ease3 = 1 - Math.pow(1 - t3, 3); // easeOutCubic
                            brainRegions.forEach((r, i) => {
                                const node = document.getElementById('brain-node-' + i);
                                const line = document.getElementById('brain-line-' + i);
                                if (node) {
                                    node.setAttribute('cx', hubCx + (origPositions[i].x - hubCx) * ease3);
                                    node.setAttribute('cy', hubCy + (origPositions[i].y - hubCy) * ease3);
                                    node.setAttribute('r', String(1.7 + ease3 * 1.1));
                                }
                                if (line) {
                                    line.setAttribute('x2', hubCx + (origPositions[i].x - hubCx) * ease3);
                                    line.setAttribute('y2', hubCy + (origPositions[i].y - hubCy) * ease3);
                                }
                            });
                            if (t3 < 1) { requestAnimationFrame(animateExpand); return; }
                            // Reset everything
                            hub.setAttribute('stroke', 'rgba(74,222,128,0.45)'); hub.setAttribute('stroke-width', '1.2');
                            hub.removeAttribute('filter');
                            brainRegions.forEach((r, i) => {
                                const node = document.getElementById('brain-node-' + i);
                                const line = document.getElementById('brain-line-' + i);
                                const label = document.getElementById('brain-label-' + i);
                                if (node) { node.setAttribute('fill', 'rgba(74,222,128,0.35)'); node.setAttribute('r', '2.8'); node.removeAttribute('filter'); }
                                if (line) { line.setAttribute('stroke', 'rgba(74,222,128,0.1)'); line.setAttribute('stroke-opacity', '1'); line.setAttribute('stroke-width', '0.6'); }
                                if (label) { label.setAttribute('fill', 'rgba(74,222,128,0.5)'); label.style.filter = 'none'; }
                            });
                            compactionRunning = false;
                        })(performance.now());
                    }, 600);
                })(performance.now());
            }, 400);
        }

        function resetBrainRegions() {
            brainRegions.forEach((_,i) => {
                const node=document.getElementById('brain-node-'+i), line=document.getElementById('brain-line-'+i), label=document.getElementById('brain-label-'+i);
                if (node) { node.setAttribute('fill','rgba(74,222,128,0.35)'); node.setAttribute('fill-opacity','1'); node.setAttribute('r','2.8'); node.setAttribute('filter','none'); }
                if (line) { line.setAttribute('stroke','rgba(74,222,128,0.1)'); line.setAttribute('stroke-opacity','1'); line.setAttribute('stroke-width','0.6'); }
                if (label) { label.setAttribute('fill','rgba(74,222,128,0.5)'); label.style.filter='none'; }
            });
            activeRegions.clear();
            document.getElementById('brain-pulses').innerHTML = '';
            const synapsesG = document.getElementById('brain-synapses');
            if (synapsesG) synapsesG.innerHTML = '';
        }
        
        // Draw curved arcs between active nodes (neural connections)
        function drawSynapticArcs(nodeIndices) {
            const synapsesG = document.getElementById('brain-synapses');
            if (!synapsesG) return;
            synapsesG.innerHTML = '';
            
            // Draw arcs between adjacent active nodes
            for (let i = 0; i < nodeIndices.length - 1; i++) {
                const idx1 = nodeIndices[i];
                const idx2 = nodeIndices[i + 1];
                const r1 = brainRegions[idx1];
                const r2 = brainRegions[idx2];
                if (!r1 || !r2) continue;
                
                // Create curved path between nodes
                const midX = (r1.x + r2.x) / 2;
                const midY = (r1.y + r2.y) / 2;
                // Control point offset perpendicular to line
                const dx = r2.x - r1.x;
                const dy = r2.y - r1.y;
                const len = Math.sqrt(dx*dx + dy*dy);
                const nx = -dy / len * 15; // perpendicular
                const ny = dx / len * 15;
                
                const path = document.createElementNS('http://www.w3.org/2000/svg','path');
                const d = `M ${r1.x},${r1.y} Q ${midX+nx},${midY+ny} ${r2.x},${r2.y}`;
                path.setAttribute('d', d);
                path.classList.add('synapse-arc');
                path.style.animationDelay = (i * 0.3) + 's';
                synapsesG.appendChild(path);
            }
            
            // If 3+ nodes, connect first and last with arc
            if (nodeIndices.length >= 3) {
                const idx1 = nodeIndices[0];
                const idx2 = nodeIndices[nodeIndices.length - 1];
                const r1 = brainRegions[idx1];
                const r2 = brainRegions[idx2];
                if (r1 && r2) {
                    const midX = (r1.x + r2.x) / 2;
                    const midY = (r1.y + r2.y) / 2;
                    const dx = r2.x - r1.x;
                    const dy = r2.y - r1.y;
                    const len = Math.sqrt(dx*dx + dy*dy);
                    const nx = -dy / len * 20;
                    const ny = dx / len * 20;
                    const path = document.createElementNS('http://www.w3.org/2000/svg','path');
                    const d = `M ${r1.x},${r1.y} Q ${midX+nx},${midY+ny} ${r2.x},${r2.y}`;
                    path.setAttribute('d', d);
                    path.classList.add('synapse-arc');
                    path.style.animationDelay = '1s';
                    synapsesG.appendChild(path);
                }
            }
        }

        // Track which lines are currently active to avoid re-animating
        var _activeLines = new Set();
        // Continuous flow dot spawner interval
        var _flowIntervals = {};

        function spawnFlowBurst(idx, color) {
            const pulsesG = document.getElementById('brain-pulses');
            const r = brainRegions[idx];
            const cx=100, cy=190;
            const hubR=18, nodeR=2.5;
            const ddist = Math.sqrt(r.dx*r.dx + r.dy*r.dy);
            const ux=r.dx/ddist, uy=r.dy/ddist;
            const x1=cx+ux*hubR, y1=cy+uy*hubR, x2=r.x-ux*nodeR, y2=r.y-uy*nodeR;
            const line = document.getElementById('brain-line-'+idx);

            // Line shoot-out animation (only on first activation)
            if (!_activeLines.has(idx) && line) {
                _activeLines.add(idx);
                const len = Math.sqrt((x2-x1)**2 + (y2-y1)**2);
                line.setAttribute('stroke-dasharray', len+' '+len);
                line.setAttribute('stroke-dashoffset', len);
                line.setAttribute('stroke', color);
                line.setAttribute('stroke-opacity', '0.6');
                line.setAttribute('stroke-width', '1');
                let shootStart = null;
                const shootDuration = 400;
                (function animShoot(ts) {
                    if (!shootStart) shootStart = ts;
                    const t = Math.min((ts - shootStart) / shootDuration, 1);
                    const eased = t < 0.5 ? 2*t*t : -1+(4-2*t)*t;
                    line.setAttribute('stroke-dashoffset', len * (1 - eased));
                    if (t < 1) requestAnimationFrame(animShoot);
                    else { line.setAttribute('stroke-dashoffset', '0'); line.removeAttribute('stroke-dasharray'); }
                })(performance.now());
            }

            // Burst of flow dots
            const burstCount = 2 + Math.floor(Math.random()*3);
            for (let b = 0; b < burstCount; b++) {
                const dot = document.createElementNS('http://www.w3.org/2000/svg','circle');
                const dotR = 1.2 + Math.random()*0.8;
                dot.setAttribute('r', dotR);
                dot.setAttribute('cx', x1);
                dot.setAttribute('cy', y1);
                dot.setAttribute('fill', color);
                dot.setAttribute('opacity', '0');
                dot.setAttribute('filter', 'drop-shadow(0 0 '+dotR+'px '+color+')');
                pulsesG.appendChild(dot);
                const duration = 800 + Math.random()*1000;
                const delay = _activeLines.has(idx) ? b * (80 + Math.random()*120) : 400 + b * (80 + Math.random()*120);
                const wobbleX = (Math.random()-0.5)*8;
                const wobbleY = (Math.random()-0.5)*8;
                let start = null;
                (function animBurst(ts) {
                    if (!start) start = ts;
                    const elapsed = ts - start - delay;
                    if (elapsed < 0) { requestAnimationFrame(animBurst); return; }
                    const t = Math.min(elapsed / duration, 1);
                    const eased = t < 0.5 ? 2*t*t : -1+(4-2*t)*t;
                    const wx = wobbleX * Math.sin(t * Math.PI);
                    const wy = wobbleY * Math.sin(t * Math.PI);
                    dot.setAttribute('cx', x1 + (x2-x1)*eased + wx);
                    dot.setAttribute('cy', y1 + (y2-y1)*eased + wy);
                    dot.setAttribute('opacity', t < 0.1 ? String(t*10) : t > 0.75 ? String((1-t)*4) : '0.85');
                    if (t < 1) requestAnimationFrame(animBurst);
                    else { try { pulsesG.removeChild(dot); } catch(e){} }
                })(performance.now());
            }
        }

        function startContinuousFlow(idx, color) {
            if (_flowIntervals[idx]) return;
            spawnFlowBurst(idx, color);
            _flowIntervals[idx] = setInterval(() => spawnFlowBurst(idx, color), 1800 + Math.random()*800);
        }

        function stopAllFlows() {
            Object.keys(_flowIntervals).forEach(k => { clearInterval(_flowIntervals[k]); delete _flowIntervals[k]; });
            _activeLines.clear();
            document.getElementById('brain-pulses').innerHTML = '';
        }

        // Legacy alias
        function spawnPulseDot(idx, color) { spawnFlowBurst(idx, color); }

        function getToolColor(tool) {
            if (!tool) return brainToolColors['default'];
            const t = tool.toLowerCase();
            for (const [key,color] of Object.entries(brainToolColors)) { if (t.includes(key)) return color; }
            return brainToolColors['default'];
        }

        function getToolRegions(tool) {
            if (!tool) return [];
            const t = tool.toLowerCase();
            for (const [key,regions] of Object.entries(brainToolToRegions)) { if (t.includes(key)) return regions; }
            return ['Reasoning'];
        }

        function updateMind(task, steps, thought) {
            if (task !== undefined) {
                mindState.task = task;
                const taskEl = document.getElementById('mind-current-task');
                if (mindState.task) { taskEl.textContent = mindState.task; taskEl.classList.remove('waiting-dots'); }
                else { taskEl.textContent = 'Awaiting instructions'; taskEl.classList.add('waiting-dots'); }
            }
            if (steps !== undefined) mindState.steps = steps;
            if (thought !== undefined) { mindState.thought = thought; document.getElementById('mind-thought-text').textContent = thought; }

            // Context compaction animation
            const compactLc = (thought || mindState.thought || '').toLowerCase();
            if (compactLc.includes('compacting') || compactLc.includes('compressing context') || compactLc.includes('context compaction')) {
                triggerCompactionAnimation();
            }

            resetBrainRegions();
            stopAllFlows();
            const hasActive = mindState.steps && mindState.steps.some(s=>s.status==='active');
            const hub = document.getElementById('brain-hub');
            const brainSvg = document.getElementById('brain-map');
            if (hasActive || mindState.task) {
                hub.setAttribute('stroke','rgba(74,222,128,0.85)'); hub.setAttribute('stroke-width','2');
                brainSvg.classList.remove('brain-idle'); brainSvg.classList.add('brain-active');
            } else {
                hub.setAttribute('stroke','rgba(74,222,128,0.45)'); hub.setAttribute('stroke-width','1.2');
                brainSvg.classList.remove('brain-active'); brainSvg.classList.add('brain-idle');
            }

            // Check for model usage and update legend
            let modelsActive = { opus: false, sonnet: false, whisper: false, ollama: false, grok: false, qwen: false, phi: false };
            if (mindState.steps) {
                mindState.steps.forEach(s => {
                    const tool = (s.tool || '').toLowerCase();
                    const model = (s.model || '').toLowerCase();
                    const text = (s.text || '').toLowerCase();
                    const combo = tool + ' ' + model + ' ' + text;
                    if (combo.includes('opus') || (combo.includes('claude') && !combo.includes('sonnet'))) modelsActive.opus = true;
                    if (combo.includes('sonnet')) modelsActive.sonnet = true;
                    if (combo.includes('whisper') || combo.includes('transcrib') || combo.includes('tts') || combo.includes('voice')) modelsActive.whisper = true;
                    if (combo.includes('ollama') || combo.includes('llama') || combo.includes('mistral')) modelsActive.ollama = true;
                    if (combo.includes('grok')) modelsActive.grok = true;
                    if (combo.includes('qwen') || combo.includes('coder')) modelsActive.qwen = true;
                    if (combo.includes('phi')) modelsActive.phi = true;
                });
            }
            // Also check thought field for model mentions
            const thoughtLc = (mindState.thought || '').toLowerCase();
            if (thoughtLc.includes('whisper') || thoughtLc.includes('transcrib')) modelsActive.whisper = true;
            if (thoughtLc.includes('grok')) modelsActive.grok = true;
            if (thoughtLc.includes('ollama')) modelsActive.ollama = true;
            updateOllamaIndicator(modelsActive.ollama);
            updateGrokIndicator(modelsActive.grok);
            
            // Update model legend dots
            ['opus', 'sonnet', 'whisper', 'ollama', 'grok', 'qwen', 'phi'].forEach(m => {
                const el = document.getElementById('model-' + m);
                if (el) el.style.opacity = modelsActive[m] ? '1' : '0.4';
            });

            const activeNodeIndices = [];
            if (mindState.steps && mindState.steps.length > 0) {
                if (hasActive || mindState.task) {
                    mindState.steps.forEach(step => {
                        if (step.status==='active'||step.status==='done') {
                            const regions=getToolRegions(step.tool||''), color=getToolColor(step.tool||'');
                            regions.forEach(r => {
                                activateBrainRegion(r, color);
                                const idx = brainRegions.findIndex(br => br.name === r);
                                if (idx !== -1 && !activeNodeIndices.includes(idx)) activeNodeIndices.push(idx);
                            });
                        }
                    });
                }
                mindState.steps.forEach(step => {
                    if (step.status==='active') {
                        const regions=getToolRegions(step.tool||''), color=getToolColor(step.tool||'');
                        regions.forEach(r => {
                            const idx=brainRegions.findIndex(br=>br.name===r);
                            if (idx!==-1) startContinuousFlow(idx, color);
                        });
                    }
                });
                
                // Always light Reasoning when brain is active (Claude is always thinking)
                if (hasActive || mindState.task) {
                    if (!activeRegions.has('Reasoning')) {
                        activateBrainRegion('Reasoning', brainToolColors['opus']);
                        const rIdx = brainRegions.findIndex(br => br.name === 'Reasoning');
                        if (rIdx !== -1 && !activeNodeIndices.includes(rIdx)) activeNodeIndices.push(rIdx);
                    }
                }

                // Thought-keyword region activation
                if (thoughtLc) {
                    const kwMap = {
                        'Memory': ['memory','reading file','writing file','saving','recalling'],
                        'Research': ['search','fetching','looking up','researching','web'],
                        'Browsing': ['browser','navigating','screenshot','scraping'],
                        'Communication': ['whatsapp','message','email','gmail','sending','transcrib','whisper','voice'],
                        'Markets': ['trading','price','market','sorare','kalshi','coinbase','stock'],
                        'Content': ['tweet','thread','x.com','posting','tiktok','substack'],
                        'Coding': ['script','code','running','exec','deploy','git']
                    };
                    // Determine dominant active model color
                    const activeModelColor = modelsActive.whisper ? '#facc15' : modelsActive.grok ? '#ef4444' : modelsActive.ollama ? '#f97316' : modelsActive.sonnet ? '#a78bfa' : 'rgba(74,222,128,0.6)';
                    Object.entries(kwMap).forEach(([region, keywords]) => {
                        if (!activeRegions.has(region) && keywords.some(kw => thoughtLc.includes(kw))) {
                            activateBrainRegion(region, activeModelColor);
                            const idx = brainRegions.findIndex(br => br.name === region);
                            if (idx !== -1 && !activeNodeIndices.includes(idx)) activeNodeIndices.push(idx);
                        }
                    });
                }

                // Draw synaptic arcs between active nodes
                if (activeNodeIndices.length > 1) {
                    drawSynapticArcs(activeNodeIndices);
                }

                const decisionIconMap = {
                    'brain': '<svg style="display:inline-block;vertical-align:middle;width:13px;height:13px;" viewBox="0 0 24 24" fill="none" stroke="#a855f7" stroke-width="2"><path d="M9.5 2A5.5 5.5 0 004 7.5c0 1.58.68 3 1.76 4L9.5 15l3.74-3.5A5.48 5.48 0 0015 7.5 5.5 5.5 0 009.5 2z"/><path d="M14.5 2A5.5 5.5 0 0120 7.5c0 1.58-.68 3-1.76 4L14.5 15"/></svg>',
                    'thought': '<svg style="display:inline-block;vertical-align:middle;width:13px;height:13px;" viewBox="0 0 24 24" fill="none" stroke="#4ade80" stroke-width="2"><path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/></svg>',
                    'chart': '<svg style="display:inline-block;vertical-align:middle;width:13px;height:13px;" viewBox="0 0 24 24" fill="none" stroke="#4ade80" stroke-width="2"><polyline points="22 7 13.5 15.5 8.5 10.5 2 17"/><polyline points="16 7 22 7 22 13"/></svg>',
                    'bar-chart': '<svg style="display:inline-block;vertical-align:middle;width:13px;height:13px;" viewBox="0 0 24 24" fill="none" stroke="#06b6d4" stroke-width="2"><rect x="4" y="12" width="4" height="8"/><rect x="10" y="6" width="4" height="14"/><rect x="16" y="9" width="4" height="11"/></svg>',
                    'calendar': '<svg style="display:inline-block;vertical-align:middle;width:13px;height:13px;" viewBox="0 0 24 24" fill="none" stroke="#eab308" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>',
                    'wrench': '<svg style="display:inline-block;vertical-align:middle;width:13px;height:13px;" viewBox="0 0 24 24" fill="none" stroke="#f97316" stroke-width="2"><path d="M14.7 6.3a1 1 0 000 1.4l1.6 1.6a1 1 0 001.4 0l3.77-3.77a6 6 0 01-7.94 7.94l-6.91 6.91a2.12 2.12 0 01-3-3l6.91-6.91a6 6 0 017.94-7.94l-3.76 3.76z"/></svg>',
                    'building': '<svg style="display:inline-block;vertical-align:middle;width:13px;height:13px;" viewBox="0 0 24 24" fill="none" stroke="#06b6d4" stroke-width="2"><rect x="4" y="2" width="16" height="20"/><line x1="9" y1="6" x2="9" y2="6.01"/><line x1="15" y1="6" x2="15" y2="6.01"/><line x1="9" y1="10" x2="9" y2="10.01"/><line x1="15" y1="10" x2="15" y2="10.01"/><line x1="9" y1="14" x2="9" y2="14.01"/><line x1="15" y1="14" x2="15" y2="14.01"/><path d="M9 22v-4h6v4"/></svg>',
                    'lobster': '<svg style="display:inline-block;vertical-align:middle;width:13px;height:13px;" viewBox="0 0 24 24" fill="none" stroke="#f97316" stroke-width="2"><circle cx="12" cy="12" r="4"/><path d="M4 8l2 2M20 8l-2 2M8 4l1 3M16 4l-1 3"/></svg>',
                    'trade': '<svg style="display:inline-block;vertical-align:middle;width:13px;height:13px;" viewBox="0 0 24 24" fill="none" stroke="#4ade80" stroke-width="2"><polyline points="22 7 13.5 15.5 8.5 10.5 2 17"/><polyline points="16 7 22 7 22 13"/></svg>',
                };
                function resolveDecisionIcon(icon) {
                    if (!icon) return decisionIconMap['thought'];
                    if (decisionIconMap[icon]) return decisionIconMap[icon];
                    // emoji fallback — return as-is
                    return icon;
                }
                const indicators = { done:'✓', active:'●', pending:'○' };
                const container = document.getElementById('mind-steps');
                // Deduplicate consecutive steps with same label
                const dedupedSteps = mindState.steps.reduce((acc, step) => {
                    if (!acc.length || (step.text||step.label||'') !== (acc[acc.length-1].text||acc[acc.length-1].label||'')) acc.push(step);
                    else acc[acc.length-1] = step; // keep latest status
                    return acc;
                }, []);
                let html = dedupedSteps.map(step => {
                    const s=step.status||'pending', ind=indicators[s]||'○';
                    const text=step.text||step.label||'';
                    const tool=step.tool||'';
                    const color=getToolColor(tool);
                    const badge=tool?`<span class="step-tool" style="background:${color}22;color:${color}">${tool}</span>`:'';
                    const dotsClass=(s==='active'&&text.toLowerCase().includes('waiting'))?' waiting-dots':'';
                    return `<div class="mind-step ${s}"><span class="step-indicator">${ind}</span><span class="${dotsClass}">${text}</span>${badge}</div>`;
                }).join('');
                // Append decisions log (deduplicated — consecutive entries with same text collapse)
                if (mindState.decisions && mindState.decisions.length) {
                    const deduped = mindState.decisions.reduce((acc, d) => {
                        if (!acc.length || (d.text||'') !== (acc[acc.length-1].text||'')) acc.push(d);
                        return acc;
                    }, []);
                    html += '<div style="border-top:1px solid rgba(255,255,255,0.06);margin-top:0.4rem;padding-top:0.4rem;">';
                    html += deduped.slice(-8).reverse().map(d => {
                        const time = d.time || '';
                        const icon = resolveDecisionIcon(d.icon);
                        const mColor = d.model ? getToolColor(d.model) : 'rgba(255,255,255,0.5)';
                        return `<div style="display:flex;gap:0.4rem;align-items:flex-start;padding:0.2rem 0;border-left:2px solid ${mColor};padding-left:0.5rem;margin:0.1rem 0;color:rgba(255,255,255,0.7);font-size:0.72rem;line-height:1.35;">
                            <span style="flex-shrink:0;font-size:0.6rem;color:rgba(255,255,255,0.25);min-width:42px;">${time}</span>
                            <span>${icon} ${d.text||''}</span>
                        </div>`;
                    }).join('');
                    html += '</div>';
                }
                container.innerHTML = html;
                container.scrollTop = container.scrollHeight;
            } else if (mindState.decisions && mindState.decisions.length) {
                // No active steps but decisions exist — show just decisions (deduplicated)
                const container = document.getElementById('mind-steps');
                const deduped2 = mindState.decisions.reduce((acc, d) => {
                    if (!acc.length || (d.text||'') !== (acc[acc.length-1].text||'')) acc.push(d);
                    return acc;
                }, []);
                container.innerHTML = deduped2.slice(-8).reverse().map(d => {
                    const time = d.time || '';
                    const icon = resolveDecisionIcon(d.icon);
                    const mColor = d.model ? getToolColor(d.model) : 'rgba(255,255,255,0.5)';
                    return `<div style="display:flex;gap:0.4rem;align-items:flex-start;padding:0.2rem 0;border-left:2px solid ${mColor};padding-left:0.5rem;margin:0.1rem 0;color:rgba(255,255,255,0.7);font-size:0.72rem;line-height:1.35;">
                        <span style="flex-shrink:0;font-size:0.6rem;color:rgba(255,255,255,0.25);min-width:42px;">${time}</span>
                        <span>${icon} ${d.text||''}</span>
                    </div>`;
                }).join('');
                container.scrollTop = container.scrollHeight;
            }
        }

        async function refreshMind(btn) {
            const doRefresh = async () => {
            try {
                const data = await fetchWithTimeout('/api/mind', 5000);
                if (!data) return;
                const lastUpdated = data.lastUpdated ? new Date(data.lastUpdated) : null;
                const staleMs = 30*60*1000;
                const isStale = lastUpdated && (new Date()-lastUpdated) > staleMs;
                if (data.decisions) mindState.decisions = data.decisions;
                updateMind(data.task, data.steps||[], data.thought || (isStale ? 'Monitoring...' : 'Ready for your next request.'));
                updateSubagentSatellites(data.subAgents);
                const hasActiveStep = (data.steps||[]).some(s=>s.status==='active');
                const isActive = !isStale && (data.task || hasActiveStep);
                document.getElementById('mind-status').textContent = isActive ? '● Active' : '○ Idle';
                document.getElementById('mind-status').style.color = isActive ? 'var(--accent)' : 'var(--text-dim)';
            } catch(e) {}
            };
            if (btn) return spinButton(btn, doRefresh());
            return doRefresh();
        }

        // ===== COINBASE WALLET + TRADES (merged) =====
        document.getElementById('wallet-toggle').addEventListener('click', () => {
            openPopup('wallet');
        });

        function truncAddr(addr) {
            if (!addr) return '';
            return addr.slice(0,6) + '…' + addr.slice(-4);
        }

        function formatSolAmount(symbol, amount) {
            // SOL amounts should NOT have $ prefix
            const sym = (symbol||'').toUpperCase();
            if (sym === 'SOL') return Number(amount).toLocaleString(undefined,{maximumFractionDigits:6}) + ' SOL';
            return '$' + Number(amount).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});
        }

        async function refreshWallet(btn) {
            const doRefresh = async () => {
                try {
                    const [data, tradesData] = await Promise.all([
                        fetchWithTimeout('/coinbase-wallet.json', 5000),
                        fetchWithTimeout('/trades.json', 5000).catch(()=>null)
                    ]);
                    if (!data) return;
                    const container = document.getElementById('wallet-content');
                    let totalUsd = (data.evm?.totalUsd||0) + (data.solana?.totalUsd||0);
                    // Include open trade values in total balance
                    if (tradesData?.openPositions) {
                        tradesData.openPositions.forEach(p => {
                            const val = (p.currentPrice||p.entryPrice||0) * (p.amount||0);
                            if (val > 0) totalUsd += val;
                        });
                    }
                    if (tradesData?.budget?.realizedPnl) {
                        totalUsd += tradesData.budget.realizedPnl;
                    }

                    document.getElementById('wallet-total-bal').textContent = '$' + totalUsd.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});

                    function renderChainCard(chain, label, iconClass, network) {
                        if (!chain) return '';
                        const addrTrunc = truncAddr(chain.address);
                        const isSolanaChain = iconClass === 'solana';
                        const balRows = (chain.balances||[]).length > 0
                            ? chain.balances.map(b => {
                                const sym = (b.symbol||b.token||'?');
                                const symLower = sym.toLowerCase();
                                const dotClass = symLower === 'sol' ? 'sol' : 'eth';
                                const isSol = symLower === 'sol';
                                const usdVal = (b.usdValue||b.usd);
                                const amtDisplay = b.amount!=null ? Number(b.amount).toLocaleString(undefined,{maximumFractionDigits:6}) : '';
                                // For SOL: show amount as "X SOL" with USD in parens; for others show $ value
                                const usdDisplay = isSol
                                    ? (usdVal!=null ? '($'+Number(usdVal).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2})+')' : '')
                                    : (usdVal!=null ? '$'+Number(usdVal).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2}) : '');
                                return `<div class="wallet-token-row">
                                    <div class="wallet-token-left">
                                        <span class="wallet-token-dot ${dotClass}"></span>
                                        <span class="wallet-token-name">${sym}</span>
                                        <span class="wallet-token-amt">${amtDisplay}${isSol?' SOL':''}</span>
                                    </div>
                                    <span class="wallet-token-usd">${usdDisplay}</span>
                                </div>`;
                            }).join('')
                            : '<div class="wallet-empty">No tokens</div>';
                        const chainUsdDisplay = isSolanaChain
                            ? Number(chain.totalUsd||0).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2})
                            : Number(chain.totalUsd||0).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});
                        return `<div class="wallet-chain-card">
                            <div class="wallet-chain-top">
                                <div class="wallet-chain-id">
                                    <div class="wallet-chain-icon ${iconClass}">${iconClass==='base'?'B':'S'}</div>
                                    <span class="wallet-chain-label">${label}${network?' · '+network:''}</span>
                                </div>
                                <span class="wallet-chain-usd">$${chainUsdDisplay}</span>
                            </div>
                            <div class="wallet-addr-row">
                                <span>${addrTrunc}</span>
                                <button class="wallet-copy-btn" onclick="event.stopPropagation();navigator.clipboard.writeText('${chain.address}');this.innerHTML='<svg style=&quot;width:12px;height:12px;&quot; viewBox=&quot;0 0 24 24&quot; fill=&quot;none&quot; stroke=&quot;#4ade80&quot; stroke-width=&quot;3&quot;><polyline points=&quot;20 6 9 17 4 12&quot;/></svg>';setTimeout(()=>this.innerHTML='<svg style=&quot;width:12px;height:12px;&quot; viewBox=&quot;0 0 24 24&quot; fill=&quot;none&quot; stroke=&quot;#4ade80&quot; stroke-width=&quot;2&quot;><rect x=&quot;9&quot; y=&quot;9&quot; width=&quot;13&quot; height=&quot;13&quot; rx=&quot;2&quot;/><path d=&quot;M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1&quot;/></svg>',1200)" title="Copy"><svg style="width:12px;height:12px;" viewBox="0 0 24 24" fill="none" stroke="#4ade80" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg></button>
                            </div>
                            ${balRows}
                        </div>`;
                    }

                    let updated = '';
                    if (data.lastUpdated) {
                        const d = new Date(data.lastUpdated);
                        updated = `<div class="wallet-footer"><span class="wallet-updated">Updated ${d.toLocaleDateString()} ${d.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</span></div>`;
                    }

                    container.innerHTML =
                        renderChainCard(data.evm, 'EVM', 'base', data.evm?.network) +
                        renderChainCard(data.solana, 'Solana', 'solana', null) +
                        updated;

                    // === Trades section (merged) ===
                    if (tradesData) {
                        const b = tradesData.budget || {};
                        // Budget bar
                        const bar = document.getElementById('trades-budget-bar');
                        const pnlColor = (b.realizedPnl||0) >= 0 ? 'var(--green)' : 'var(--red)';
                        bar.innerHTML = `
                            <span class="trades-budget-pill" style="background:rgba(74,222,128,0.15);color:var(--green);">Avail: ${(b.availableSol||b.available||0).toFixed(2)} SOL</span>
                            <span class="trades-budget-pill" style="background:rgba(255,255,255,0.06);color:var(--text);">Deployed: ${(b.deployedSol||b.deployed||0).toFixed(2)} SOL</span>
                            <span class="trades-budget-pill" style="background:rgba(255,255,255,0.06);color:${pnlColor};">P&L: ${(b.realizedPnl||0) >= 0 ? '+' : ''}${(b.realizedPnl||0).toFixed(3)} SOL</span>
                        `;
                        // Open positions
                        const openEl = document.getElementById('trades-open');
                        const positions = tradesData.openPositions || [];
                        if (positions.length) {
                            openEl.innerHTML = positions.map(p => {
                                const pnl = p.currentPrice && p.entryPrice ? ((p.currentPrice - p.entryPrice) / p.entryPrice * 100) : (p.pnlPct || 0);
                                const pnlClass = pnl >= 0 ? 'green' : 'red';
                                const solSpent = p.solSpent ? p.solSpent.toFixed(2) + ' SOL' : '';
                                const fmtMcap = (v) => v >= 1e6 ? '$' + (v/1e6).toFixed(1) + 'M' : v >= 1e3 ? '$' + (v/1e3).toFixed(0) + 'K' : '$' + v;
                                const entryMcap = p.mcapAtEntry || 0;
                                const curMcap = p.currentMcap || entryMcap;
                                return `<div class="trades-pos-row">
                                    <span class="trades-pos-token">${p.token||p.symbol}</span>
                                    <span class="trades-pos-meta">Entry MCap: ${fmtMcap(entryMcap)}</span>
                                    <span class="trades-pos-meta">Now: ${fmtMcap(curMcap)}</span>
                                    <span class="trades-pos-meta">${solSpent}</span>
                                    <span class="trades-pos-pnl ${pnlClass}">${pnl >= 0 ? '+' : ''}${pnl.toFixed(1)}%</span>
                                </div>`;
                            }).join('');
                        } else {
                            openEl.innerHTML = '<span style="color:var(--text-dim);font-size:0.75rem;">No open positions</span>';
                        }
                        // Closed trades
                        const closedEl = document.getElementById('trades-closed');
                        const closed = tradesData.closedPositions || tradesData.closedTrades || [];
                        if (closed.length) {
                            closedEl.innerHTML = closed.slice(-5).reverse().map(t => {
                                const pnl = t.pnlPct || 0;
                                const pnlClass = pnl >= 0 ? 'green' : 'red';
                                return `<div class="trades-closed-row">
                                    <span>${t.token||t.symbol}</span>
                                    <span class="trades-pos-pnl ${pnlClass}">${pnl >= 0 ? '+' : ''}${pnl.toFixed(1)}%</span>
                                    <span style="color:var(--text-dim)">${t.closedAt ? new Date(t.closedAt).toLocaleDateString() : ''}</span>
                                </div>`;
                            }).join('');
                        } else {
                            closedEl.innerHTML = '<span style="color:var(--text-dim);font-size:0.75rem;">No closed trades yet</span>';
                        }
                        // Compact trades for collapsed view
                        const compactEl = document.getElementById('wallet-trades-compact');
                        if (positions.length) {
                            compactEl.innerHTML = positions.map(p => {
                                const pnl = p.currentPrice && p.entryPrice ? ((p.currentPrice - p.entryPrice) / p.entryPrice * 100) : (p.pnlPct || 0);
                                const pnlClass = pnl >= 0 ? 'green' : 'red';
                                const curPrice = p.currentPrice || p.entryPrice || 0;
                                const fmtMc = (v) => v >= 1e6 ? '$' + (v/1e6).toFixed(1) + 'M' : v >= 1e3 ? '$' + (v/1e3).toFixed(0) + 'K' : '$' + v;
                                const cMcap = p.currentMcap || p.mcapAtEntry || 0;
                                return `<div class="wallet-compact-trade">
                                    <span class="wct-token">${p.token||p.symbol}</span>
                                    <span class="wct-prices">${fmtMc(p.mcapAtEntry||0)} → ${fmtMc(cMcap)}</span>
                                    <span class="wct-pnl ${pnlClass}">${pnl >= 0 ? '+' : ''}${pnl.toFixed(1)}%</span>
                                </div>`;
                            }).join('');
                        } else {
                            compactEl.innerHTML = '';
                        }
                    }
                } catch(e) { console.error('Wallet:', e); }
            };
            if (btn) return spinButton(btn, doRefresh());
            return doRefresh();
        }

        // Alias for backward compat with WS handler
        function refreshTrades() { return refreshWallet(); }

        // ===== REFRESH ALL =====
        function refreshAll() {
            const mainBtn = document.getElementById('refresh-all-btn');
            if (mainBtn) mainBtn.classList.add('spinning');
            document.querySelectorAll('.refresh-btn').forEach(btn=>btn.classList.add('spinning'));
            refreshSystem(); refreshXStats(); refreshDesktopTweetFeed();
            refreshConnections(); refreshSorare(); refreshMind(); refreshWallet();
            setTimeout(() => {
                if (mainBtn) mainBtn.classList.remove('spinning');
                document.querySelectorAll('.refresh-btn').forEach(btn=>btn.classList.remove('spinning'));
            }, 1500);
        }

        // ===== INIT =====
        try { initBrainMap(); } catch(e) { console.warn('Brain init:', e.message); }
        refreshMind().catch(e=>console.warn('Mind:',e.message));
        refreshSystem().catch(e=>console.warn('System:',e.message));
        refreshXStats().catch(e=>console.warn('XStats:',e.message));
        refreshDesktopTweetFeed().catch(e=>console.warn('Tweets:',e.message));
        refreshConnections().catch(e=>console.warn('Connections:',e.message));
        refreshSorare().catch(e=>console.warn('Sorare:',e.message));

        refreshWallet().catch(e=>console.warn('Wallet:',e.message));

        // Auto-refresh
        // Usage limits (session + weekly)
        function timeUntil(isoStr) {
            const ms = new Date(isoStr).getTime() - Date.now();
            if (ms <= 0) return 'now';
            const h = Math.floor(ms / 3600000), m = Math.floor((ms % 3600000) / 60000);
            if (h > 24) { const d = Math.floor(h / 24); return d + 'd ' + (h % 24) + 'h'; }
            return h ? h + 'h ' + m + 'm' : m + 'm';
        }
        async function refreshUsageLimits() {
            try {
                const r = await fetch('/usage-limits.json?_=' + Date.now());
                if (!r.ok) return;
                const d = await r.json();
                const sessEl = document.getElementById('session-limit-slim');
                const wkEl = document.getElementById('weekly-limit-slim');
                if (sessEl && d.session) {
                    const p = d.session.pct;
                    sessEl.textContent = 'Sess: ' + p + '% (' + timeUntil(d.session.resetsAt) + ')';
                    sessEl.className = 'status-slim-pill ' + (p > 80 ? 'red' : p > 50 ? '' : 'green');
                    sessEl.title = 'Anthropic session limit — resets ' + new Date(d.session.resetsAt).toLocaleTimeString('en-US', {hour:'numeric',minute:'2-digit'});
                }
                if (wkEl && d.weekly) {
                    const p = d.weekly.pct;
                    wkEl.textContent = 'Wk: ' + p + '% (' + timeUntil(d.weekly.resetsAt) + ')';
                    wkEl.className = 'status-slim-pill ' + (p > 80 ? 'red' : p > 50 ? '' : 'green');
                    wkEl.title = 'Anthropic weekly limit — resets ' + new Date(d.weekly.resetsAt).toLocaleTimeString('en-US', {hour:'numeric',minute:'2-digit',weekday:'short'});
                }
            } catch(e) {}
        }
        refreshUsageLimits();
        setInterval(refreshUsageLimits, 30000);

        setInterval(refreshMind, 5000);
        setInterval(()=>{ refreshSystem(); }, 30000);
        setInterval(refreshXStats, 900000);
        setInterval(refreshDesktopTweetFeed, 60000);
        setInterval(refreshSorare, 300000);
        setInterval(refreshConnections, 600000);
        setInterval(refreshWallet, 60000);

        // WebSocket
        (function connectWS() {
            const proto = location.protocol==='https:'?'wss:':'ws:';
            const ws = new WebSocket(proto+'//'+location.host);
            ws.onmessage = (evt) => {
                try {
                    const msg = JSON.parse(evt.data);
                    // Night mode toggle from mobile — trigger existing night mode overlay
                    if (msg.type === 'nightMode') {
                        if (msg.enabled) { toggleNightMode(); } else { exitNightMode(); }
                        return;
                    }
                    const wsPending = {};
                    function wsRefresh(key, fn) {
                        if (wsPending[key]) return;
                        wsPending[key] = true;
                        requestAnimationFrame(() => { wsPending[key] = false; fn(); });
                    }
                    function handleWidget(k) {
                        if (k==='x-tweets'||k==='x-thread-history'||k==='x-latest-tweets') wsRefresh('x-tweets', refreshDesktopTweetFeed);
                        else if (k==='x-stats') wsRefresh('x-stats', refreshXStats);
                        else if (k==='mind') refreshMind();
                        else if (k==='sessions') refreshMind();
                        else if (k==='sorare'||k==='sorare-mobile') refreshSorare();
                        else if (k==='coinbase-wallet') refreshWallet();
                        else if (k==='trades') refreshTrades();
                        else if (k==='cron-schedule') fetchJobs();
                    }
                    if (msg.type==='update') handleWidget(msg.widget);
                    else if (msg.type==='batch'&&msg.updates) msg.updates.forEach(u=>handleWidget(u.widget));
                } catch(e) {}
            };
            ws.onclose = () => setTimeout(connectWS, 1000);
            ws.onerror = () => ws.close();
        })();

        // ===== POP-UP PANEL SYSTEM =====
        function openPopup(type) {
            const backdrop = document.getElementById('popup-backdrop');
            const popup = document.getElementById(type + '-popup');
            const popupContent = document.getElementById(type + '-popup-content');

            // Clone content into popup
            if (type === 'wallet') {
                const src = document.getElementById('wallet-body');
                popupContent.innerHTML = src.innerHTML;
            } else if (type === 'jobs') {
                const src = document.getElementById('jobs-body');
                popupContent.innerHTML = src.innerHTML;
            } else if (type === 'conn') {
                const src = document.getElementById('conn-body');
                popupContent.innerHTML = src.innerHTML;
            }

            backdrop.classList.add('active');
            popup.classList.add('active');
        }
        function closePopup(type) {
            const backdrop = document.getElementById('popup-backdrop');
            const popup = document.getElementById(type + '-popup');
            backdrop.classList.remove('active');
            popup.classList.remove('active');
        }
        // Close on backdrop click
        document.getElementById('popup-backdrop').addEventListener('click', () => {
            document.querySelectorAll('.popup-panel.active').forEach(p => p.classList.remove('active'));
            document.getElementById('popup-backdrop').classList.remove('active');
        });
        // Close on Escape
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                document.querySelectorAll('.popup-panel.active').forEach(p => p.classList.remove('active'));
                document.getElementById('popup-backdrop').classList.remove('active');
            }
        });

        // Night Mode
        let bouncingAnimation=null, bounceX=50, bounceY=50, bounceVX=1.5, bounceVY=1;
        function toggleNightMode() {
            document.getElementById('night-mode-overlay').classList.add('active');
            updateNightModeClock(); startBouncingLogo();
        }
        function exitNightMode() {
            document.getElementById('night-mode-overlay').classList.remove('active');
            if (bouncingAnimation) { cancelAnimationFrame(bouncingAnimation); bouncingAnimation=null; }
        }
        function startBouncingLogo() {
            const logo=document.getElementById('bouncing-logo'), overlay=document.getElementById('night-mode-overlay');
            (function animate() {
                if (!overlay.classList.contains('active')) return;
                bounceX+=bounceVX; bounceY+=bounceVY;
                if (bounceX<=0||bounceX>=window.innerWidth-120) { bounceVX=-bounceVX; bounceX=Math.max(0,Math.min(bounceX,window.innerWidth-120)); }
                if (bounceY<=0||bounceY>=window.innerHeight-120) { bounceVY=-bounceVY; bounceY=Math.max(0,Math.min(bounceY,window.innerHeight-120)); }
                logo.style.left=bounceX+'px'; logo.style.top=bounceY+'px';
                bouncingAnimation=requestAnimationFrame(animate);
            })();
        }
        function updateNightModeClock() {
            if (!document.getElementById('night-mode-overlay').classList.contains('active')) return;
            const now=new Date(), h=now.getHours(), m=now.getMinutes().toString().padStart(2,'0');
            document.getElementById('eink-time').textContent=(h%12||12)+':'+m;
            document.getElementById('eink-ampm').textContent=h>=12?'PM':'AM';
            document.getElementById('eink-date').textContent=now.toLocaleDateString('en-US',{weekday:'long',month:'long',day:'numeric'});
            setTimeout(updateNightModeClock, 1000);
        }

        // Auto-hide cursor
        let cursorTimeout;
        function hideCursor() { document.body.style.cursor='none'; }
        function showCursor() { document.body.style.cursor=''; }
        function resetCursorTimer() { showCursor(); clearTimeout(cursorTimeout); cursorTimeout=setTimeout(hideCursor,60000); }
        document.addEventListener('mousemove',resetCursorTimer);
        document.addEventListener('mousedown',resetCursorTimer);
        resetCursorTimer();

        // Hard refresh: left + right arrow keys pressed simultaneously
        const arrowState = { left: false, right: false };
        document.addEventListener('keydown', e => {
            if (e.key === 'ArrowLeft') arrowState.left = true;
            if (e.key === 'ArrowRight') arrowState.right = true;
            if (arrowState.left && arrowState.right) {
                arrowState.left = false;
                arrowState.right = false;
                location.reload(true);
            }
        });
        document.addEventListener('keyup', e => {
            if (e.key === 'ArrowLeft') arrowState.left = false;
            if (e.key === 'ArrowRight') arrowState.right = false;
        });
    </script>
</body>
</html>
